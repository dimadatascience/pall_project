---
title: "PALL visualization data"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    theme: united
    code_folding: hide
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "Gianluca Alessio Mariani"

params:
  manual_timestamp: "250929_0900"
  project: "pall"
  clinical_data: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/clinical_data.csv"
  id_data: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PATIENTS_ID.csv"
  maf_tumor_dir: "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4/annotations/variant_annotations/250916/annotation/somatic"
  cnv_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/variantalker/results/250923_1647_pall/250923/annotation/cnv"
  raw_samples_dir: "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4"
  results_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results"
  refgene_file: "/hpcnfs/scratch/DIMA/gmariani/__softwares/gistic2/gistic2/refgenes/hg38.UCSC.add_mir.160920/gistic2.refgene.hg38.UCSC.add_miR.160920.mat"
  cytoband_file: "/hpcnfs/scratch/DIMA/gmariani/_databases/reference_genomes/hg38/cytoBand_hg38_merged.txt"
  gene_table1: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_PrimaryTumors/FINAL_DATASET.csv"
  gene_table2: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_RelapseTumors/FINAL_DATASET.csv"
  cnvkit_out_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results/250918_1626_cnvkit_pall"
  run_gistic2: FALSE
  num_top_genes: 25
  num_top_regions: 40
  type2use4cn_onco: "anno" #either "anno" or "seg"
  thr4gain: 0.30
  thr4amp: 0.90 
  thr4loss: -0.30 
  thr4deep: -0.90 
---

# Maftools Report

This report has been generated with R.

It contains the analysis for the PALL project, performed on a small set of 21 patients.

For each patient a DNA sample was collected at times t = diagnosis and subsequent relapses.

WES sequencing, variant calling and annotation was performed in previous steps to obtain the data presented in this report.

In particular the tools used to generate the input data are:

  - DRAGEN (4.4.4): sequencing, variant calling and CNV annotation
  
  - Variantalker (beta): small variants annotation
  
  - CNVkit (0.9.12): additional CNV annotation

```{r setup_knit, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.align = "center",
	fig.height = 8,
	fig.width = 10,
	message = FALSE,
	warning = FALSE,
	autodep = TRUE,
	cache = FALSE,
	dev = c("png", "pdf")
)
```

```{r params_for_interactive_session}
# Chunk: setup_parameters
if (!exists("params")) {
  params <- list(
    manual_timestamp = "250929_0900",
    project = "pall",
    clinical_data = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/clinical_data.csv",
    maf_tumor_dir = "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4/annotations/variant_annotations/250916/annotation/somatic",
    cnv_dir = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/variantalker/results/250923_1647_pall/250923/annotation/cnv",
    raw_samples_dir = "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4",
    results_dir = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results",
    refgene_file = "/hpcnfs/scratch/DIMA/gmariani/__softwares/gistic2/gistic2/refgenes/hg38.UCSC.add_mir.160920/gistic2.refgene.hg38.UCSC.add_miR.160920.mat",
    gene_table1 = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_PrimaryTumors/FINAL_DATASET.csv",
    gene_table2 = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_RelapseTumors/FINAL_DATASET.csv",
    cnvkit_out_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results/250918_1626_cnvkit_pall",
    run_gistic2 = FALSE
  )
}

if (!is.null(params$manual_timestamp) && 
    !is.na(params$manual_timestamp) &&
    params$manual_timestamp != "") {
  manual_timestamp <- params$manual_timestamp
} else {
  manual_timestamp <- format(Sys.time(), "%y%m%d_%H%M")
}
```

```{r load_libraries_and_setup, results='hide'}
library(grDevices)
library(maftools)
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)
library(GenomicRanges)
library(readr)
library("mclust")
library(ggplot2)
library(circlize)
library(RCircos)
library("RColorBrewer")
library(grDevices)
library(ComplexHeatmap)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library('org.Hs.eg.db')
library(AnnotationDbi)
library(biovizBase)
library(grid)
library(purrr)
library(ggrepel)
library("DT")
```

```{r func_get_sample_id}
get_sample_id <- function(filepath) {
  tools::file_path_sans_ext(basename(filepath)) %>% 
    sub("\\.cnv\\.annotated$", "", .) %>% 
    sub("\\.target\\.counts$", "", .)
}
```

```{r func_process_cnv_sample}
process_cnv_sample <- function(cnv_file) {
  sample_id <- strsplit(basename(cnv_file), "\\.")[[1]][[1]]
  
  # 1. Leggi CNV
  cnv <- tryCatch({
    read.delim(cnv_file, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  }, error = function(e) {
    message(sprintf("Errore nella lettura di %s: %s", cnv_file, e$message))
    return(NULL)
  })
  
  if (is.null(cnv) || !"All.protein.coding.genes" %in% colnames(cnv)) return(NULL)
  cnv <- cnv[cnv$All.protein.coding.genes != "", ]
  cnv$CNV_Status <- ifelse(cnv$Type == "DEL", "Del",
                           ifelse(cnv$Type == "DUP", "Amp", NA))
  cnv <- cnv[!is.na(cnv$CNV_Status), ]
  if (nrow(cnv) == 0) return(NULL)

  cnv_gr <- GRanges(
    seqnames = cnv$Chromosome,
    ranges = IRanges(start = cnv$Start, end = cnv$End)
  )

  # ðŸ”¹ File gene-level (solo se ti serve)
  gene_annotation_df <- cnv %>%
    mutate(Sample = sample_id,
           Start_Position = Start,
           End_Position = End) %>%
    separate_rows(All.protein.coding.genes, sep = ",\\s*") %>%
    mutate(Hugo_Symbol = All.protein.coding.genes) %>%
    dplyr::select(Hugo_Symbol, Sample, CNV_Status, Chromosome, Start_Position, End_Position, Classification)

  # Ritorna entrambi
  return(list(
    cnv_list = gene_annotation_df
  ))
}
```

```{r func_apply_priority}
apply_priority <- function(df, colnames_list, priority, new_colname = "Clinical_Significance_Summary") {
  
  colnames_vec <- unlist(colnames_list)
  df <- as.data.frame(df)
  
  # Funzione che prende un vettore di tag e sceglie quello con prioritÃ  piÃ¹ alta
  select_highest_priority <- function(tags) {
    tags <- trimws(tags)
    tags <- tags[tags != "" & !is.na(tags)]
    
    for (p in priority) {
      if (p %in% tags) return(p)
    }
    return(NA_character_)
  }
  
  df[[new_colname]] <- apply(df[, colnames_vec, drop=FALSE], 1, select_highest_priority)
  
  return(data.table(df))
}
```

```{r func_simplify_clinvar}
simplify_clinvar <- function(value, priority, mapping) {
  if (is.na(value) || trimws(value) == "") {
    return("Not_Provided")
  }
  
  # Split per tutti i separatori
  tags <- unlist(strsplit(value, "[|/;,]"))
  tags <- trimws(tags)
  
  # Applica il mapping ai tag
  mapped_tags <- sapply(tags, function(x) {
    if (x %in% names(mapping)) {
      return(mapping[[x]])
    } else {
      return(x)
    }
  }, USE.NAMES = FALSE)
  
  # Trova il primo tag con prioritÃ  piÃ¹ alta nel mapping
  for (p in priority) {
    if (p %in% mapped_tags) {
      return(p)
    }
  }
  
  # Se nessun match nella prioritÃ , restituisce il primo tag mappato
  return(mapped_tags[1])
}
```

```{r func_preproc_oncocn}
preproc_oncocn <- function(dt,
                           cyto_file,
                           gain = 0.30,
                           loss = -0.30,
                           top_regions = 50) {

  # ---- 1) Preprocessing ----
  dt_test <- dt %>%
    mutate(
      Chromosome = ifelse(grepl("^chr", Chromosome), Chromosome, paste0("chr", Chromosome)),
      original_call = ifelse(is.na(Type) | Type == "", NA, Type),
      log2R_seg = ifelse(Segment_Mean > 0, log2(Segment_Mean), NA)   # evita -Inf
    )

  # ---- 2) GRanges ----
  cnv_gr <- GRanges(
    seqnames = dt_test$Chromosome,
    ranges = IRanges(start = dt_test$Start, end = dt_test$End),
    sample = dt_test$Sample,
    log2R = dt_test$log2R_seg,
    original_call = dt_test$original_call
  )

  # ---- 3) Cytoband ----
  cyto <- read.delim(cyto_file, header = FALSE, stringsAsFactors = FALSE)
  colnames(cyto) <- c("chrom", "chromStart", "chromEnd", "name", "gieStain")

  cyto_gr <- GRanges(
    seqnames = cyto$chrom,
    ranges = IRanges(start = cyto$chromStart + 1, end = cyto$chromEnd),
    name = cyto$name,
    gieStain = cyto$gieStain
  )

  cyto_gr$region <- paste0(seqnames(cyto_gr), cyto_gr$name)

  # ---- 4) Match seqlevels ----
  seqlevelsStyle(cnv_gr) <- "UCSC"
  common <- intersect(seqlevels(cyto_gr), seqlevels(cnv_gr))
  cyto_gr <- keepSeqlevels(cyto_gr, common, pruning.mode = "coarse")
  cnv_gr  <- keepSeqlevels(cnv_gr, common, pruning.mode = "coarse")

  # ---- 5) Overlap ----
  ov <- findOverlaps(cnv_gr, cyto_gr, ignore.strand = TRUE)
  qh <- queryHits(ov)
  sh <- subjectHits(ov)

  ints <- pintersect(cnv_gr[qh], cyto_gr[sh])

  df_raw <- data.frame(
    sample = cnv_gr$sample[qh],
    region = cyto_gr$region[sh],
    log2R = cnv_gr$log2R[qh],
    original_call = cnv_gr$original_call[qh],
    w = width(ints),
    stringsAsFactors = FALSE
  )

  # ---- 6) Weighted mean per regione ----
  df <- df_raw %>%
    group_by(sample, region) %>%
    summarise(
      log2R = weighted.mean(log2R, w, na.rm = TRUE),
      original_call = original_call[which.max(w)],
      .groups = "drop"
    )

  # ---- 7) Tua classificazione: SOLO DEL/DUP ----
  df <- df %>%
    mutate(
      my_call = case_when(
        log2R <= loss ~ "DEL",
        log2R >= gain ~ "DUP",
        TRUE ~ NA_character_
      )
    )

  # ---- 8) Final call = DRAGEN se disponibile ----
  df <- df %>%
    mutate(
      final_call = ifelse(
        is.na(original_call) | original_call == "",
        my_call,
        original_call
      )
    ) %>%
    filter(!is.na(final_call))

  # ---- 9) Matrice regione Ã— sample ----
  mat <- df %>%
    dplyr::select(sample, region, final_call) %>%
    pivot_wider(names_from = sample, values_from = final_call, values_fill = "") %>%
    group_by(region) %>%
    summarise(across(everything(), ~ paste(unique(.), collapse = ";")),
              .groups = "drop") %>%
    tibble::column_to_rownames("region") %>%
    as.matrix()

  # ---- 10) Selezione top regioni ----
  region_freq <- apply(mat, 1, function(x) sum(x != ""))
  top_regions <- names(sort(region_freq, decreasing = TRUE))[1:top_regions]
  mat_top <- mat[top_regions, , drop = FALSE]

  # ---- 11) Oncoprint setup ----
  col_map <- c(DUP = "#e41a1c", DEL = "#377eb8")

  alter_fun <- list(
    background = function(x, y, w, h) {
      grid::grid.rect(x, y, w, h,
                      gp = grid::gpar(fill = "#f2f2f2", col = NA))
    },
    DUP = function(x, y, w, h) {
      grid::grid.rect(x, y, w * 0.9, h * 0.9,
                      gp = grid::gpar(fill = col_map["DUP"], col = NA))
    },
    DEL = function(x, y, w, h) {
      grid::grid.rect(x, y, w * 0.9, h * 0.9,
                      gp = grid::gpar(fill = col_map["DEL"], col = NA))
    }
  )

  get_type <- function(x) strsplit(x, ";")[[1]]

  return(list(
    mat_top = mat_top,
    col_map = col_map,
    alter_fun = alter_fun,
    get_type = get_type,
    df = df   # utile per debug/analisi mismatch
  ))
}
```

```{r func_savepdf}
save_pdf_plot <- function(plot_expr, pdf_dir) {

  # Recupera opzioni del chunk corrente
  opts <- knitr::opts_current$get()
  
  # Nome del chunk
  chunk_name <- opts$label
  if (is.null(chunk_name) || chunk_name == "") {
    chunk_name <- "unnamed_chunk"
  }
  
  # Dimensioni del chunk
  fig_width  <- opts$fig.width  %||% 10
  fig_height <- opts$fig.height %||% 8
  
  # Assicurati che la cartella esista
  dir.create(pdf_dir, recursive = TRUE, showWarnings = FALSE)
  
  # Gestione del nome con indice progressivo
  index <- 1
  pdf_file <- file.path(pdf_dir, paste0(chunk_name, "-", index, ".pdf"))
  while (file.exists(pdf_file)) {
    index <- index + 1
    pdf_file <- file.path(pdf_dir, paste0(chunk_name, "-", index, ".pdf"))
  }
  
  # Salva il PDF
  pdf(pdf_file, width = fig_width, height = fig_height)
  eval(plot_expr)   # esegue il plot
  dev.off()
  
  message("PDF salvato in: ", pdf_file)
}
```

## Setup & Preprocessing

### Genelist preprocessing

The analysis will focus only on a provided specific list of 300 genes.

All oncoplots will be filtered for this specific set of 300 genes.

```{r preprocessing_genelist, results='hide'}
samples <- list.dirs(params$maf_tumor_dir, full.names = FALSE, recursive = FALSE)

final_genetable <- bind_rows(
  read_csv(params$gene_table1),
  read_csv(params$gene_table2)
)

genelist <- unique(final_genetable$Hugo_Symbol)
```

### CNV files preprocessing

The cnv files from DRAGEN are preprocessed and joined in a single final file.

```{r preprocessing_cnv_files, results='hide'}
cnv_files <- file.path(params$cnv_dir, samples, paste0(samples, ".cnv.annotated.tsv"))
cnv_files <- cnv_files[file.exists(cnv_files)]

cnv_samples <- setNames(cnv_files, sapply(cnv_files, get_sample_id))

results <- lapply(cnv_files, process_cnv_sample)

# Combina tutti i risultati validi
cnv_combined <- bind_rows(lapply(results, `[[`, "cnv_list"))
```

### Maf Object generation

The MAF object is generated through maftools (2.24.0) by combining the mafs from the small variants analysis (DRAGEN -> Variantalker), the cnv files from DRAGEN and the clinical data provided.

```{r generate_files, results='hide'}
maf_files <- file.path(params$maf_tumor_dir, samples, paste0(samples, ".maf"))
maf_files <- maf_files[file.exists(maf_files)]
merged_maf <- merge_mafs(maf_files)

id_map <- read.csv(params$id_data, stringsAsFactors = FALSE)
barcode_map <- setNames(id_map$SAMPLENAME, id_map$code)

maf_data_mapped <- merged_maf@data
clinical_mapped <- read.csv(params$clinical_data, stringsAsFactors = FALSE)
cnv_mapped <- cnv_combined

# Converti a character
maf_data_mapped$Tumor_Sample_Barcode <- as.character(maf_data_mapped$Tumor_Sample_Barcode)
clinical_mapped$Tumor_Sample_Barcode <- as.character(clinical_mapped$Tumor_Sample_Barcode)
cnv_mapped$Sample <- as.character(cnv_mapped$Sample)

# Mapping
maf_data_mapped$Tumor_Sample_Barcode_new <- barcode_map[ maf_data_mapped$Tumor_Sample_Barcode ]
clinical_mapped$Tumor_Sample_Barcode_new <- barcode_map[ clinical_mapped$Tumor_Sample_Barcode ]
cnv_mapped$Sample_new <- barcode_map[ cnv_mapped$Sample ]

# Controllo missing
unique(maf_data_mapped$Tumor_Sample_Barcode[ is.na(maf_data_mapped$Tumor_Sample_Barcode_new) ])
unique(clinical_mapped$Tumor_Sample_Barcode[ is.na(clinical_mapped$Tumor_Sample_Barcode_new) ])
unique(cnv_mapped$Sample[ is.na(cnv_mapped$Sample_new) ])

# Se tutto OK â†’ sostituisci
maf_data_mapped$Tumor_Sample_Barcode <- maf_data_mapped$Tumor_Sample_Barcode_new
clinical_mapped$Tumor_Sample_Barcode <- clinical_mapped$Tumor_Sample_Barcode_new
cnv_mapped$Sample <- cnv_mapped$Sample_new

maf_data_mapped$Tumor_Sample_Barcode_new <- NULL
clinical_mapped$Tumor_Sample_Barcode_new <- NULL
cnv_mapped$Sample_new <- NULL

cnv_mapped$Classification <- gsub(" ", "_", cnv_mapped$Classification)

cnv_mapped$Classification <- gsub("likely_pathogenic", "Likely_Pathogenic", cnv_mapped$Classification, ignore.case = TRUE)
cnv_mapped$Classification <- gsub("uncertain_significance", "Uncertain_Significance", cnv_mapped$Classification, ignore.case = TRUE)
cnv_mapped$Classification <- gsub("benign", "Benign", cnv_mapped$Classification, ignore.case = TRUE)
cnv_mapped$Classification <- gsub("pathogenic", "Pathogenic", cnv_mapped$Classification, ignore.case = TRUE)


maf_obj <- read.maf(
  maf = maf_data_mapped,
  clinicalData = clinical_mapped,
  cnTable = cnv_mapped
)
```

### Preprocessing MAF

The MAF object is preprocessed to:

  - add columns that contain an additional classification based on:
  
    - the most pathogenic tag of the variant between the Clinvar, Cancervar and VARSOME annotations
    
    - the most pathogenic tag of the variant between the Clinvar and Cancervar annotations
    
  - filter the variant list by:
  
    - discarding variants with VAF < 0.05
    
    - discarding fishing genes ("MUC", "TTN", "RYR", "OR", "KRT")
    
    - discarding variants in non important regions such as "Splice_Site", "Silent", "Intron", "5'UTR" ...

```{r clin_summary_setup}
clinvar_dict <- c("Pathogenic" = "Pathogenic",
    "Pathogenic/Likely_pathogenic" = "Pathogenic",
    "Likely_pathogenic" = "Likely_Pathogenic",
    "Uncertain_significance" = "Uncertain_Significance",
    "Conflicting_classifications_of_pathogenicity" = "Uncertain_Significance",
    "Conflicting_interpretations_of_pathogenicity" = "Uncertain_Significance",
    "Likely_benign" = "Likely_Benign",
    "Benign/Likely_benign" = "Likely_Benign",
    "Benign" = "Benign",
    "drug_response" = "Drug_Response",
    "not_provided" = "Not_Provided",
    "no_classifications_from_unflagged_records" = "Unknown",
    "risk_factor" = "Unknown",
    "Affects" = "Unknown",
    "no_classification_for_the_single_variant" = "Unknown",
    "association" = "Unknown",
    "other" = "Unknown",
    "Uncertain_risk_allele" = "Unknown",
    "Likely_risk_allele" = "Unknown",
    "_low_penetrance" = "Unknown",
    "protective" = "Unknown",
    "association_not_found" = "Unknown",
    "Established_risk_allele" = "Unknown",
    "confers_sensitivity" = "Unknown")

cancervar_dict <- list("Tier_I_strong" = "Pathogenic",
    "Tier_II_potential" = "Likely_Pathogenic",
    "Tier_III_Uncertain" = "Uncertain_Significance",
    "Tier_IV_benign" = "Benign")

varsome_dict  <- list("TierI" = "Pathogenic",
                      "TierIV" = "Benign",
                      "TierIII" = "Uncertain_Significance",
                      "??" = "Unknown",
                      "TierII" = "Likely_pathogenic",
                      "???" = "Unknown")

priority_order <- list("Pathogenic",
    "Likely_Pathogenic",
    "Uncertain_Significance",
    "Likely_Benign",
    "Benign",
    "Drug_Response",
    "Not_Provided",
    "Unknown")

cols_to_check_clin_canc <- list("CancerVar", "ClinVar_VCF_CLNSIG")
cols_to_check_chiara <- list("VARSOME", "CancerVar", "ClinVar_VCF_CLNSIG")
```

```{r clin_summary_exec, results='hide'}
maf_data <- maf_obj@data

maf_data <- maf_data %>%
  dplyr::left_join(
    final_genetable %>% dplyr::select(Chromosome, Start_Position, End_Position, VARSOME),
    by = c("Chromosome", "Start_Position", "End_Position")
  )

maf_data$ClinVar_VCF_CLNSIG <- sapply(
  maf_data$ClinVar_VCF_CLNSIG,
  simplify_clinvar,
  priority = priority_order,
  mapping = clinvar_dict,
  USE.NAMES = FALSE
)
maf_data$CancerVar[is.na(maf_data$CancerVar)] <- "Not_Provided"
maf_data$CancerVar <- recode(maf_data$CancerVar, !!!cancervar_dict)
maf_data$VARSOME[is.na(maf_data$VARSOME)] <- "Not_Provided"
maf_data$VARSOME <- recode(maf_data$VARSOME, !!!varsome_dict)

# Filter VAF > n

min_vaf = 0.05
maf_data <- maf_data[maf_data$tumor_f > min_vaf]
to_remove <- c("Splice_Site", "Silent", "Intron", "5'UTR")
maf_data <- maf_data[!maf_data$Variant_Classification %in% to_remove]

fishing_genes <- c("MUC", "TTN", "RYR", "OR", "KRT")
non_fishing_genes <- c("ORC1", "MUCL3", "MUCL1", "KRTCAP3")

regex_fishing <- paste0("^(", paste(fishing_genes, collapse = "|"), ")")
possible_fishing <- grepl(regex_fishing , maf_data$Hugo_Symbol)
false_positives <- maf_data$Hugo_Symbol %in% non_fishing_genes
flag_fishing_genes <- possible_fishing & !false_positives
maf_data_filtered <- maf_data[!flag_fishing_genes, ]

maf_data_filtered <- apply_priority(maf_data_filtered, cols_to_check_clin_canc, priority_order, new_colname = "Clinical_Significance_Summary_Clinvar_Cancervar")
maf_data_filtered <- apply_priority(maf_data_filtered, cols_to_check_chiara, priority_order, new_colname = "Clinical_Significance_Summary_Chiara")

mafobj_allgenes <- read.maf(maf = maf_data_filtered, clinicalData = clinical_mapped, cnTable = cnv_mapped)
```

### Genelists filtering

For convenience, a series of maf objects are generated by subsetting the original maf to keep only the variants with a pathogenicity tier above a certain tier. This will be useful to generate the final oncoplots.

The list of genes associated with each maf is also generated.

```{r genelists, results='hide'}
maf_300 <- mafobj_allgenes@data[Hugo_Symbol %in% genelist, ]
cnv_300 <- cnv_mapped[cnv_mapped$Hugo_Symbol %in% genelist, ]
mafobj_300 <- read.maf(maf = maf_300, clinicalData = clinical_mapped, cnTable = cnv_300)

tier1 <- c("Pathogenic")
tier2 <- c("Pathogenic", "Likely_Pathogenic")
tier3 <- c("Pathogenic", "Likely_Pathogenic", "Uncertain_Significance")

maf_t1 <- maf_300[maf_300$Clinical_Significance_Summary_Clinvar_Cancervar %in% tier1, ]
cnv_t1 <- cnv_300[cnv_300$Classification %in% tier1, ]
mafobj_t1 <- read.maf(maf = maf_t1, cnTable = cnv_t1, clinicalData = clinical_mapped)

maf_t2 <- maf_300[maf_300$Clinical_Significance_Summary_Clinvar_Cancervar %in% tier2, ]
cnv_t2 <- cnv_300[cnv_300$Classification %in% tier2, ]
mafobj_t2 <- read.maf(maf = maf_t2, cnTable = cnv_t2, clinicalData = clinical_mapped)

maf_t3 <- maf_300[maf_300$Clinical_Significance_Summary_Clinvar_Cancervar %in% tier3, ]
cnv_t3 <- cnv_300[cnv_300$Classification %in% tier3, ]
mafobj_t3 <- read.maf(maf = maf_t3, cnTable = cnv_t3, clinicalData = clinical_mapped)

maf_t1_c <- maf_300[maf_300$Clinical_Significance_Summary_Chiara %in% tier1, ]
cnv_t1_c <- cnv_300[cnv_300$Classification %in% tier1, ]
mafobj_t1_c <- read.maf(maf = maf_t1_c, cnTable = cnv_t1_c, clinicalData = clinical_mapped)

maf_t2_c <- maf_300[maf_300$Clinical_Significance_Summary_Chiara %in% tier2, ]
cnv_t2_c <- cnv_300[cnv_300$Classification %in% tier2, ]
mafobj_t2_c <- read.maf(maf = maf_t2_c, cnTable = cnv_t2_c, clinicalData = clinical_mapped)

maf_t3_c <- maf_300[maf_300$Clinical_Significance_Summary_Chiara %in% tier3, ]
cnv_t3_c <- cnv_300[cnv_300$Classification %in% tier3, ]
mafobj_t3_c <- read.maf(maf = maf_t3_c, cnTable = cnv_t3_c, clinicalData = clinical_mapped)

genes_t1   <- getGeneSummary(mafobj_t1)$Hugo_Symbol
genes_t2   <- getGeneSummary(mafobj_t2)$Hugo_Symbol
genes_t3   <- getGeneSummary(mafobj_t3)$Hugo_Symbol

genes_t1_c <- getGeneSummary(mafobj_t1_c)$Hugo_Symbol
genes_t2_c <- getGeneSummary(mafobj_t2_c)$Hugo_Symbol
genes_t3_c <- getGeneSummary(mafobj_t3_c)$Hugo_Symbol
```

```{r filters_genes, results='hide'}
clin_data <- mafobj_allgenes@clinical.data
clin_data_sorted <- clin_data[order(clin_data$T1221, clin_data$Sample_group), ]
clin_data_sorted_samples_paired <- clin_data[order(clin_data$Tumor_Sample_Barcode, clin_data$T1221, clin_data$Sample_group), ]
clin_data_sorted[, patient_id := sub("-.*", "", Tumor_Sample_Barcode)]
clin_data_sorted[, sample_suffix := sub(".*-(.*)", "\\1", Tumor_Sample_Barcode)]
clin_data_sorted[, sample_num := as.integer(sub("ALL([0-9]+).*", "\\1", Tumor_Sample_Barcode))]

sample_order <- clin_data_sorted$Tumor_Sample_Barcode
sample_order_paired <- clin_data_sorted_samples_paired$Tumor_Sample_Barcode

# gene filters
topN <- params$num_top_genes

top_t1   <- head(mafobj_t1@gene.summary[order(-MutatedSamples)]$Hugo_Symbol, topN)
top_t2   <- head(mafobj_t2@gene.summary[order(-MutatedSamples)]$Hugo_Symbol, topN)
top_t3   <- head(mafobj_t3@gene.summary[order(-MutatedSamples)]$Hugo_Symbol, topN)

top_t1_c <- head(mafobj_t1_c@gene.summary[order(-MutatedSamples)]$Hugo_Symbol, topN)
top_t2_c <- head(mafobj_t2_c@gene.summary[order(-MutatedSamples)]$Hugo_Symbol, topN)
top_t3_c <- head(mafobj_t3_c@gene.summary[order(-MutatedSamples)]$Hugo_Symbol, topN)
```

### Sample lists filtering

Similarly to the genes, the sample list is also filtered by clinical conditions and ordered to be used in the final oncoplots.

```{r filters_samples, results='hide'}
# sample filters
sample_order_diag_relapse <- clin_data_sorted[Sample_group %in% c("diag", "relapse1")][order(T1221, sample_num, sample_suffix)]$Tumor_Sample_Barcode
maf_obj_filtered_diag_relapse <- subsetMaf(maf = maf_obj, tsb = sample_order_diag_relapse)

samples_neg_diag_relapse <- clin_data_sorted[T1221 == "NEG" & Sample_group %in% c("diag", "relapse1")][order(sample_num, sample_suffix)]$Tumor_Sample_Barcode

samples_pos_diag_relapse <- clin_data_sorted[T1221 == "POS" & Sample_group %in% c("diag", "relapse1")][order(sample_num, sample_suffix)]$Tumor_Sample_Barcode


sample_order_diag <- clin_data_sorted[Sample_group == "diag"][order(sample_num, sample_suffix)]$Tumor_Sample_Barcode
maf_obj_filtered_diag <- subsetMaf(maf = maf_obj, tsb = sample_order_diag)

sample_order_relapse <- clin_data_sorted[Sample_group == "relapse1"][order(sample_num, sample_suffix)]$Tumor_Sample_Barcode
maf_obj_filtered_relapse <- subsetMaf(maf = maf_obj, tsb = sample_order_relapse)

samples_neg <- clin_data_sorted[T1221 == "NEG"][order(sample_num, sample_suffix)]$Tumor_Sample_Barcode
maf_obj_filtered_neg <- subsetMaf(maf = maf_obj, tsb = samples_neg)
samples_pos <- clin_data_sorted[T1221 == "POS"][order(sample_num, sample_suffix)]$Tumor_Sample_Barcode
maf_obj_filtered_pos <- subsetMaf(maf = maf_obj, tsb = samples_pos)

sample_order_patient_adj <- clin_data_sorted[order(T1221, sample_num, sample_suffix)]$Tumor_Sample_Barcode
```

```{r setup_directories}
# setup directories
output_dir <- file.path(params$results_dir, paste0(manual_timestamp, "_", params$project))
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
```

## Summary

The summary plots were generated with maftools.

They provide an overview of the cohort data by showing informations about the variant classification, the top 10 mutated genes and the distribution across samples. 

In the top 10 mutated genes section:

  - the bar length represents the total number of mutations found for that particular gene across all samples
  
  - the percentage represents the fraction of samples with at least one mutation in that gene

### Summary - all samples

```{r summary1}
plotmafSummary(maf = mafobj_allgenes, rmOutlier = TRUE, addStat = "median", dashboard = TRUE, titvRaw = FALSE)
```

### Summary - diagnosis samples

```{r summary2}
plotmafSummary(maf = maf_obj_filtered_diag, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
```

### Summary - first relapse samples

```{r summary3}
plotmafSummary(maf = maf_obj_filtered_relapse, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
```

## Oncoplots

All small variants oncoplots were generated with maftools.

Each oncoplot was generated by taking into account:

  - The tier filter (above I only, above II only and above III only) and the tiering method (most pathogenic across Clinvar, Cancervar and VARSOME (VCC) vs Clinvar and Cancervar only (CC))
  
  - The number of top genes to plot (25)
  
  - The sample grouping (either by clinical info (T1221 = based on detection of the traslocation of chr 12 to chr 21, Sample_group = diagnosis, relapses), or by patient (diagnosis and relapses grouped together))

### Most pathogenic in VCC, Tier I and II genes

#### All samples

```{r oncoplot1, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = mafobj_t2_c,
  genes = top_t2_c,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```


#### All samples, by patient

```{r oncoplot1bypat, results='hide', echo=FALSE}
oncoplot(
  maf = mafobj_t2_c,
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot1pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2_c, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot1neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2_c, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




### Most pathogenic in VCC, Tier I, II and III genes

#### All samples

```{r oncoplot2, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = mafobj_t3_c,
  genes = top_t3_c, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

#### All samples, by patient

```{r oncoplot2bypat, results='hide', echo=FALSE}
oncoplot(
  maf = mafobj_t3_c,
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot2pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3_c, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot2neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3_c, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```



### Most pathogenic in CC, Tier I and II genes

#### All samples

```{r oncoplot3, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = mafobj_t2,
  genes = top_t2, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

#### All samples, by patient

```{r oncoplot3bypat, results='hide', echo=FALSE}
oncoplot(
  maf = mafobj_t2,
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot3pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot3neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```





### Most pathogenic in CC, Tier I, II and III genes, all samples

#### All samples

```{r oncoplot4, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = mafobj_t3,
  genes = top_t3, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

#### All samples, by patient

```{r oncoplot4bypat, results='hide', echo=FALSE}
oncoplot(
  maf = mafobj_t3,
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot4pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot4neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




### Most pathogenic in VCC, Tier I and II genes, only diagnosis and relapse 1 samples

#### All samples

```{r oncoplot5, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = mafobj_t2_c, tsb = sample_order_diag_relapse),
  genes = top_t2_c, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

#### All samples, by patient

```{r oncoplot5bypat, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2_c, tsb = sample_order_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot5pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2_c, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot5neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2_c, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




### Most pathogenic in VCC, Tier I, II and III genes, only diagnosis and relapse 1 samples

#### All samples

```{r oncoplot6, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = mafobj_t3_c, tsb = sample_order_diag_relapse),
  genes = top_t3_c, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

#### All samples, by patient

```{r oncoplot6bypat, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3_c, tsb = sample_order_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot6pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3_c, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot6neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3_c, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




### Most pathogenic in CC, Tier I, and II genes, only diagnosis and relapse 1 samples

#### All samples

```{r oncoplot7, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = mafobj_t2, tsb = sample_order_diag_relapse),
  genes = top_t2, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

#### All samples, by patient

```{r oncoplot7bypat, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2, tsb = sample_order_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot7pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot7neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t2, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




### Most pathogenic in CC, Tier I, II and III genes, only diagnosis and relapse 1 samples

#### All samples

```{r oncoplot8, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = mafobj_t3, tsb = sample_order_diag_relapse),
  genes = top_t3, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

#### All samples, by patient

```{r oncoplot8bypat, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3, tsb = sample_order_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order_patient_adj
  )
```

#### Positive samples

```{r oncoplot8pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

#### Negative samples

```{r oncoplot8neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = mafobj_t3, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```



## Other Plots

Additional secondary plots from maftools.

### Transitions-Transversions

The plot contains informations on the sample rate of transition vs transversions for all samples and their distribution across samples.

```{r transition_transversions, fig.height=13}
maf_obj.titv = titv(maf = mafobj_allgenes, plot = FALSE, useSyn = TRUE)
plotTiTv(res = maf_obj.titv, showBarcodes = TRUE)
```

### TMB Comparison Graph

The plot shows a comparison between the analyzed cohort and a set of standardized cohorts from the literature and tumor classification. The cohorts are compared by average Tumor mutational burden.

```{r TMB_comparison}
maf_obj.mutload = tcgaCompare(maf = mafobj_allgenes, cohortName = 'PALL', logscale = TRUE, capture_size = 50)
```

### VAF Plots

The VAF plots show the VAF distribution of the top 20 genes in the selected 300 gene list by VAF.

#### VAF Plot, positive samples, most pathogenic in CC, Tier I and II genes

```{r vaf_plot1, results='hide', echo=FALSE}
plotVaf(maf = subsetMaf(maf = mafobj_t2, tsb = samples_pos), vafCol = 'tumor_f', genes = genes_t2)
```

#### VAF Plot, negative samples, most pathogenic in CC, Tier I and II genes

```{r vaf_plot2, results='hide', echo=FALSE}
plotVaf(maf = subsetMaf(maf = mafobj_t2, tsb = samples_neg), vafCol = 'tumor_f', genes = genes_t2)
```

#### VAF Plot, positive samples, most pathogenic in VCC, Tier I and II genes

```{r vaf_plot3, results='hide', echo=FALSE}
plotVaf(maf = subsetMaf(maf = mafobj_t2_c, tsb = samples_pos), vafCol = 'tumor_f', genes = genes_t2_c)
```

#### VAF Plot, negative samples, most pathogenic in VCC, Tier I and II genes

```{r vaf_plot4, results='hide', echo=FALSE}
plotVaf(maf = subsetMaf(maf = mafobj_t2_c, tsb = samples_neg), vafCol = 'tumor_f', genes = genes_t2_c)
```

## Copy number Manhattan Plots

This section contains the Manhattan plots generated from the copy number data from DRAGEN and CNVkit. 

The plots are generated with ggplot2 (4.0.0).

```{r setup_genelist_cnvkit}
gene_entrez <- AnnotationDbi::select(org.Hs.eg.db,
                                    keys = genelist,
                                    keytype = "SYMBOL",
                                    columns = c("ENTREZID"))

gene_entrez <- gene_entrez %>% filter(!is.na(ENTREZID))
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
gene_ranges <- genes(txdb, columns = c("gene_id"))
gene_ranges_filtered <- gene_ranges[names(gene_ranges) %in% gene_entrez$ENTREZID]
gene_df <- as.data.frame(gene_ranges_filtered) %>%
  dplyr::select(seqnames, start, end, width, strand, gene_id)

gene_annotated <- gene_entrez %>%
  inner_join(gene_df, by = c("ENTREZID" = "gene_id")) %>%
  dplyr::rename(
    Chromosome = seqnames,
    Start_Position = start,
    End_Position = end
  )
gene_annotated <- gene_annotated %>%
  mutate(Chromosome = gsub("^chr", "", Chromosome))
```

### CN CNVKit, Manhattan Plot, Segments

The CNVkit Manhattan plots have been generated from the CNVkit output which was in turn generated from the tumor and normal cram files from DRAGEN.

These plots show on the Y axis the log2R of the copy number of each region calculated directly by CNVkit. 

The plot has been centered at value log2R = 0 for all patients and the log2R values have been capped at +- 2.5 to limit the outliers effect on influencing the plot scaling from patient to patient. 

An additional gene label has been added by taking the initial list of 300 genes and evaluating if each one of these genes would fall in a copy number region with a log2R absolute value > 0.5.

```{r manhattan_manual_seg_cnvkit}

log2_cap_max <- 2.5
log2_cap_min <- -2.5
log2_visible_max <- 2.49
log2_visible_min <- -2.49

thres_logplot <- 0.5

aspect_ratio_manhattan_plots = 1/2

cnvkit_path <- list.dirs(params$cnvkit_out_dir, recursive = FALSE)
  
for (c_path in cnvkit_path) {

  sample_raw <- basename(c_path)
  sample_mapped <- barcode_map[sample_raw]
  
  file <- file.path(c_path, paste0(sample_raw, "_tumor.cns"))
  
  cns <- read_tsv(file, show_col_types = FALSE)
  # Potresti dover adattare se il file Ã¨ delimitato da tab, spazio, etc
  
  cns2 <- cns %>%
    mutate(
      chromosome = gsub("^chr", "", chromosome),
      mid = (start + end) / 2,
    ) %>%
    filter(chromosome %in% as.character(1:22)) %>%  # <-- FILTRO CHR X/Y
    mutate(
      chromosome = factor(chromosome, levels = as.character(1:22))  # solo chr 1-22
    ) %>%
    arrange(chromosome, start)
  
  # Calcola posizioni cumulative
  chr_sizes <- cns2 %>%
    group_by(chromosome) %>%
    summarize(chr_max = max(end)) %>%
    arrange(chromosome) %>%
    mutate(chr_cum_start = lag(cumsum(chr_max), default = 0))

  cns3 <- cns2 %>%
    left_join(chr_sizes, by = "chromosome") %>%
    mutate(pos_cum = mid + chr_cum_start,
           seg_width = end - start)
  
  cns3 <- cns3 %>%
    mutate(
      log2_capped = case_when(
        log2 > log2_cap_max ~ log2_visible_max,
        log2 < log2_cap_min ~ log2_visible_min,
        TRUE ~ log2
      )
    )
  
  cns3 <- cns3 %>%
    mutate(chromosome = as.character(chromosome))
  
  cnv_gr <- GRanges(
    seqnames = cns3$chromosome,
    ranges = IRanges(start = cns3$start, end = cns3$end),
    log2_capped = cns3$log2_capped,
    pos_cum = cns3$pos_cum
  )
  
  genes_gr <- GRanges(
    seqnames = gene_annotated$Chromosome,
    ranges = IRanges(start = gene_annotated$Start_Position, end = gene_annotated$End_Position),
    gene = gene_annotated$SYMBOL
  )
  
  hits <- findOverlaps(cnv_gr, genes_gr)

  # Estrai i segmenti CNV coinvolti e i geni associati
  df_hits <- data.frame(
    queryHits = queryHits(hits),
    subjectHits = subjectHits(hits)
  )
  
  # Unisci info segmenti CNV e geni
  df_annot <- df_hits %>%
    mutate(
      pos_cum = mcols(cnv_gr)$pos_cum[queryHits],
      log2_capped = mcols(cnv_gr)$log2_capped[queryHits],
      gene = mcols(genes_gr)$gene[subjectHits],
      chromosome = cns3$chromosome[queryHits]
    ) %>%
    group_by(queryHits, pos_cum, log2_capped, chromosome) %>%
    summarise(genes = paste(unique(gene), collapse = ", "), .groups = "drop")
  
  df_annot_filtered <- df_annot %>%
    filter(log2_capped > thres_logplot | log2_capped < -thres_logplot) %>%
    mutate(vjust_label = ifelse(log2_capped > 0, -0.5, 1.5))

  # Calcola centro dei cromosomi per label
  centers <- chr_sizes %>%
    mutate(center = chr_cum_start + chr_max/2)
  
  n_chrom <- length(levels(cns3$chromosome))
    chrom_colors <- colorRampPalette(brewer.pal(12, "Paired"))(n_chrom)
    
  x_total <- max(cns3$pos_cum) - min(cns3$pos_cum)
  nudge_range <- 0.05 * x_total
  
  # 4. Plot
  p <- ggplot(cns3, aes(x = pos_cum, y = log2_capped, group = chromosome)) +
    geom_segment(aes(x = start + chr_cum_start,
                     xend = end + chr_cum_start,
                     y = log2_capped, yend = log2_capped,
                     color = chromosome), linewidth = 1) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    geom_text_repel(
      data = df_annot_filtered,
      aes(x = pos_cum, y = log2_capped, label = genes),
      size = 2,
      nudge_y = ifelse(df_annot_filtered$log2_capped > 0, 0.2, -0.2),
      nudge_x = runif(nrow(df_annot_filtered), -nudge_range, nudge_range),
      direction = "y",
      segment.size = 0.2,
      segment.color = "grey60",
      box.padding = 0.2,
      force = 2,           # forza la separazione tra label
      force_pull = 0.5     # quanto le lineette possono allungarsi
    ) +
    scale_y_continuous(limits = c(log2_cap_min, log2_cap_max)) +
    scale_x_continuous(breaks = centers$center, labels = centers$chromosome, expand = c(0,0)) +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, size = 6),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      aspect.ratio = aspect_ratio_manhattan_plots
    ) +
    labs(
      title = paste("Copy number segments (line plot) for sample", sample_mapped),
      x = "Chromosome",
      y = "Log2 copy number ratio"
    )
  
  print(p)
}
```

### CN DRAGEN annotation files + CNVKit seg files, Manhattan Plot, Segments

The DRAGEN Manhattan plots have been generated directly from the DRAGEN output that has been annotated by Variantalker (ClassifyCNV, ".cnv.annotated.tsv" files).

These plots show on the Y axis the log2R of the copy number of each region calculated directly by CNVkit.

The plot has been centered at value log2R = 0 for all patients and the log2R values have been capped at +- 2.5 to limit the outliers effect on influencing the plot scaling from patient to patient. 

An additional gene label has been added by taking the list of genes contained in the column "Known or predicted dosage-sensitive genes" from each .cnv.annotated.tsv patient file.

Only the mutations classified as Pathogenic or Likely Pathogenic by ClassifyCNV were taken.

In this case the threshold has been removed since the genes listed in the annotated file should be already above threshold, considering they have been annotated for copy number effects.

```{r mapping_seg2cnv}
raw_paths <- list.dirs(params$raw_samples_dir, recursive = FALSE)
cnvkit_paths <- list.dirs(params$cnvkit_out_dir, recursive = FALSE)
cnv_paths <- list.dirs(params$cnv_dir, recursive = FALSE)
raw_df <- data.frame(basename = basename(raw_paths), raw_path = raw_paths, stringsAsFactors = FALSE)
cnvkit_df <- data.frame(basename = basename(cnvkit_paths), cnvkit_path = cnvkit_paths, stringsAsFactors = FALSE)
cnv_df <- data.frame(basename = basename(cnv_paths), cnv_path = cnv_paths, stringsAsFactors = FALSE)

mapping_table <- raw_df %>%
  inner_join(cnv_df, by = "basename") %>%
  inner_join(cnvkit_df, by = "basename") %>%
  mutate(
    raw_file_candidate1 = file.path(raw_path, paste0(basename, ".seg")),
    raw_file_candidate2 = file.path(raw_path, paste0(basename, "_germline.seg")),
    raw_file = case_when(
      file.exists(raw_file_candidate1) ~ raw_file_candidate1,
      file.exists(raw_file_candidate2) ~ raw_file_candidate2,
      TRUE ~ NA_character_
    ),
    raw_file_exists = !is.na(raw_file) & file.exists(raw_file),
    cnv_file = file.path(cnv_path, paste0(basename, ".cnv.annotated.tsv")),
    cnv_file_exists = file.exists(cnv_file),
    cnvkit_file = file.path(cnvkit_path, paste0(basename, "_tumor.cns")),
    cnvkit_file_exists = file.exists(cnvkit_file),
    ## ðŸ”‘ mapping barcode â†’ ID biologico
    new_id = unname(barcode_map[basename])
  ) %>%
  dplyr::select(
    basename,
    new_id,
    raw_path,
    cnv_path,
    cnvkit_path,
    raw_file,
    cnv_file,
    cnvkit_file,
    raw_file_exists,
    cnv_file_exists,
    cnvkit_file_exists
  )

all_genes <- mapping_table %>%
  filter(cnv_file_exists) %>%
  pull(cnv_file) %>%
  map(~ {
    df <- read_tsv(.x, col_types = cols())

    df %>%
      filter(Classification %in% c("Likely pathogenic", "Pathogenic")) %>%
      pull(`Known or predicted dosage-sensitive genes`)
  }) %>%
  unlist(use.names = FALSE) %>%
  na.omit() %>%
  # separa valori con virgole
  str_split(pattern = ",\\s*") %>%  
  unlist(use.names = FALSE) %>%
  # rimuove eventuali spazi
  str_trim() %>%
  unique()
```

```{r setup_genelist_dragen_manhattan}
gene_entrez <- AnnotationDbi::select(org.Hs.eg.db,
                                    keys = all_genes,
                                    keytype = "SYMBOL",
                                    columns = c("ENTREZID"))

gene_entrez <- gene_entrez %>% filter(!is.na(ENTREZID))
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
gene_ranges <- genes(txdb, columns = c("gene_id"))
gene_ranges_filtered <- gene_ranges[as.character(names(gene_ranges)) %in% gene_entrez$ENTREZID]
gene_df <- as.data.frame(gene_ranges_filtered) %>%
  dplyr::select(seqnames, start, end, width, strand, gene_id)

gene_annotated <- gene_entrez %>%
  inner_join(gene_df, by = c("ENTREZID" = "gene_id")) %>%
  dplyr::rename(
    Chromosome = seqnames,
    Start_Position = start,
    End_Position = end
  )
gene_annotated <- gene_annotated %>%
  mutate(Chromosome = gsub("^chr", "", Chromosome))
```

```{r setup_dragen_manhattan}
aspect_ratio_manhattan_plots <- 1/2
y_min <- -2.5
y_max <- 2.5
bin_size <- 1e7
maptab_l <- seq_len(nrow(mapping_table))
```

```{r plot_dragen_manhattan}
# Lista dei campioni dal mapping table
sample_index_list <- seq_len(nrow(mapping_table))

for (i in sample_index_list) {

  sample_raw <- mapping_table$basename[i]
  cnvkit_file <- mapping_table$cnvkit_file[i]
  
  if (!mapping_table$cnvkit_file_exists[i]) next
  
  sample_map <- barcode_map[sample_raw]
  if (is.na(sample_map)) {
    warning(paste("ATTENZIONE: barcode non trovato nel mapping:", sample_raw))
    next
  }

  # ---- Leggi CNVkit ----
  cns <- read_tsv(cnvkit_file, col_types = cols()) %>%
    mutate(
      chromosome = gsub("^chr", "", chromosome),
      mid = (start + end) / 2
    ) %>%
    filter(chromosome %in% as.character(1:22)) %>%
    mutate(chromosome = factor(chromosome, levels = as.character(1:22))) %>%
    arrange(chromosome, start)

  # ---- Calcola posizioni cumulative ----
  chr_sizes <- cns %>%
    group_by(chromosome) %>%
    summarize(chr_max = max(end), .groups = "drop") %>%
    arrange(chromosome) %>%
    mutate(chr_cum_start = lag(cumsum(as.numeric(chr_max)), default = 0))

  cns2 <- cns %>%
    left_join(chr_sizes, by = "chromosome") %>%
    mutate(
      pos_cum = mid + chr_cum_start,
      log2_capped = pmin(pmax(log2, log2_cap_min), log2_cap_max)
    )

  # ---- Colori cromosomi ----
  chrom_colors <- setNames(
    colorRampPalette(RColorBrewer::brewer.pal(12, "Paired"))(length(levels(cns2$chromosome))),
    levels(cns2$chromosome)
  )

  # ---- GRanges per CNV ----
  cnv_gr <- GRanges(
    seqnames = cns2$chromosome,
    ranges = IRanges(start = cns2$start, end = cns2$end),
    log2_capped = cns2$log2_capped,
    pos_cum = cns2$pos_cum
  )

  # ---- Annotazioni geni ----
  df_annot <- NULL
  if (!is.na(mapping_table$cnv_file[i]) && file.exists(mapping_table$cnv_file[i])) {
    cnv_data <- read_tsv(mapping_table$cnv_file[i], col_types = cols())
    
    genes_raw <- cnv_data %>%
      filter(Classification %in% c("Likely pathogenic", "Pathogenic")) %>%
      pull(`Known or predicted dosage-sensitive genes`) %>%
      str_split(",\\s*") %>%
      unlist() %>%
      str_trim() %>%
      unique()
    
    if (length(genes_raw) > 0) {
      
      gene_entrez <- AnnotationDbi::select(org.Hs.eg.db,
                                           keys = genes_raw,
                                           keytype = "SYMBOL",
                                           columns = c("ENTREZID")) %>%
        filter(!is.na(ENTREZID))
      
      txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
      gene_ranges <- genes(txdb, columns = c("gene_id"))
      gene_ranges_filtered <- gene_ranges[names(gene_ranges) %in% gene_entrez$ENTREZID]
      
      gene_df <- as.data.frame(gene_ranges_filtered) %>%
        dplyr::select(seqnames, start, end, width, strand, gene_id)
      
      gene_annotated <- gene_entrez %>%
        inner_join(gene_df, by = c("ENTREZID" = "gene_id")) %>%
        dplyr::rename(
          Chromosome = seqnames,
          Start_Position = start,
          End_Position = end
        ) %>%
        mutate(Chromosome = gsub("^chr", "", Chromosome))
      
      genes_gr <- GRanges(
        seqnames = gene_annotated$Chromosome,
        ranges = IRanges(start = gene_annotated$Start_Position, end = gene_annotated$End_Position),
        gene = gene_annotated$SYMBOL
      )
      
      # ---- Trova il segmento CNV con maggiore sovrapposizione per ciascun gene ----
      hits <- findOverlaps(genes_gr, cnv_gr)  # genes come query, CNV come subject
      if (length(hits) > 0) {
        ovl_width <- pintersect(genes_gr[queryHits(hits)], cnv_gr[subjectHits(hits)]) %>% width()
        
        gene_hits <- data.frame(
          gene = mcols(genes_gr)$gene[queryHits(hits)],
          cnv_idx = subjectHits(hits),
          overlap = ovl_width
        ) %>%
          group_by(gene) %>%
          slice_max(overlap, n = 1, with_ties = FALSE) %>%
          ungroup()
        
        df_annot <- gene_hits %>%
          mutate(
            pos_cum = mcols(cnv_gr)$pos_cum[cnv_idx],
            log2_capped = mcols(cnv_gr)$log2_capped[cnv_idx],
            chromosome = cns2$chromosome[cnv_idx],
            genes = gene
          )
      }
    }
  }

  # ---- Centri cromosomi per asse x ----
  centers <- chr_sizes %>%
    mutate(center = chr_cum_start + chr_max/2)
  
  x_total <- max(cns2$pos_cum) - min(cns2$pos_cum)
  nudge_range <- 0.08 * x_total  # 2% della lunghezza totale

  # ---- Plot ----
  p <- ggplot(cns2, aes(x = pos_cum, y = log2_capped, group = chromosome)) +
    geom_segment(aes(x = start + chr_cum_start,
                     xend = end + chr_cum_start,
                     y = log2_capped, yend = log2_capped,
                     color = chromosome), size = 1) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    scale_color_manual(values = chrom_colors) +
    scale_x_continuous(breaks = centers$center, labels = centers$chromosome, expand = c(0,0)) +
    coord_cartesian(ylim = c(y_min, y_max)) +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, size = 6),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      aspect.ratio = aspect_ratio_manhattan_plots
    ) +
    labs(
      title = paste("Copy number segments (line plot) for sample", sample_map),
      x = "Chromosome",
      y = "Log2 copy number ratio"
    )

  if (!is.null(df_annot) && nrow(df_annot) > 0) {
    p <- p + geom_text_repel(
      data = df_annot,
      aes(x = pos_cum, y = log2_capped, label = genes),
      size = 2,
      nudge_y = ifelse(df_annot$log2_capped > 0, 0.2, -0.2),
      nudge_x = runif(nrow(df_annot), -nudge_range, nudge_range),
      direction = "y",
      segment.size = 0.2,
      segment.color = "grey60",
      box.padding = 0.2,
      force = 2,
      force_pull = 0.5
    )
  }

  print(p)
}
```

### CN Oncoplot, DRAGEN annotation/seg files

The copy number oncoplots have been generated from the same DRAGEN annotation files used for the DRAGEN Manhattan plots. 

3 different oncoplots have been generated based on the mutations tiering described above (tier I and above, tier II and above, tier III and above).

The logRatio used to define amplifications or deletions was already calculated by DRAGEN and the categories used to classify each copy number are simply Amplifications and Deletions.

``` {r oncoplot_setup}
all_seg_data <- list()

raw_path <- list.dirs(params$raw_samples_dir, recursive = FALSE)
cnv_path <- list.dirs(params$cnv_dir, recursive = FALSE)

if (params$type2use4cn_onco == "seg") {
  
  for (c_path in raw_path) {
    
    sample_raw <- basename(c_path)
    
    # controlla formato sample
    if (grepl("^PALL[0-9A-Za-z]+-[0-9]+T[0-9A-Za-z]+$", sample_raw)) {
      
      # mapping sicuro
      sample_mapped <- barcode_map[sample_raw]
      if (is.na(sample_mapped)) {
        warning(paste("ATTENZIONE: sample non presente nel mapping:", sample_raw))
        next
      }
      
      file <- file.path(c_path, paste0(sample_raw, ".seg"))
      if (file.exists(file)) {
        seg_data <- read_tsv(file, col_types = cols())
        seg_data$Sample <- sample_mapped
        all_seg_data[[length(all_seg_data) + 1]] <- seg_data
      }
    }
  }
  
} else if (params$type2use4cn_onco == "anno") {
  
  for (c_path in cnv_path) {
    
    sample_raw <- basename(c_path)
    
    # controlla formato sample
    if (grepl("^PALL[0-9A-Za-z]+-[0-9]+T[0-9A-Za-z]+$", sample_raw)) {
      
      # mapping sicuro
      sample_mapped <- barcode_map[sample_raw]
      if (is.na(sample_mapped)) {
        warning(paste("ATTENZIONE: sample non presente nel mapping:", sample_raw))
        next
      }
      
      file <- file.path(c_path, paste0(sample_raw, ".cnv.annotated.tsv"))
      if (file.exists(file)) {
        seg_data <- read_tsv(file, col_types = cols())
        
        # assegna sample mappato
        seg_data$Sample <- sample_mapped
        
        # colonne richieste
        required_cols <- c("Sample", "Chromosome", "Start", "End", "Type", "Classification", "logRatio", "CNF")
        present_cols <- intersect(names(seg_data), required_cols)
        
        if (!"CNF" %in% present_cols) {
          stop(paste("File", file, "does not contain required column 'CNF'"))
        }
        
        seg_data <- seg_data %>%
          dplyr::select(all_of(present_cols)) %>%
          dplyr::rename(Segment_Mean = CNF)
        
        all_seg_data[[length(all_seg_data) + 1]] <- seg_data
      }
    }
  }
  
} else {
  stop(paste("ERROR: parameter 'type2use4cn_onco' must be 'seg' or 'anno'. Parameter used =", params$type2use4cn_onco))
}

# combina tutti i dati
dt <- bind_rows(all_seg_data)
all_samples <- unique(dt$Sample) 

# filtra cromosomi sessuali
dt <- dt %>%
  dplyr::filter(!Chromosome %in% c("chrX", "chrY"))

# subset per Tier
dt_I <- dt %>%
  filter(Classification %in% c("Pathogenic"))
dt_I_II <- dt %>%
  filter(Classification %in% c("Pathogenic", "Likely pathogenic")) 
dt_I_II_III <- dt %>%
  filter(Classification %in% c("Pathogenic", "Likely pathogenic", "Uncertain significance")) 


# info clinica sample
clinical_sample_info <- data.frame(maf_obj@clinical.data)

# colori per i plot
t1221_colors <- c(NEG = "#1f78b4", POS = "#33a02c", NE = "#b2df8a")
sample_group_colors <- c(diag = "#e41a1c", relapse1 = "#377eb8", relapse2 = "#4daf4a")
```

#### CN Oncoplot, all samples, tier I

```{r oncoplot_dragen_cnbands_filter1, fig.width = 12}
cn_block <- preproc_oncocn(
  dt = dt_I, 
  cyto_file = params$cytoband_file, 
  gain = params$thr4gain, 
  loss = params$thr4loss, 
  top_regions = params$num_top_regions
)

mat_top <- cn_block$mat_top
get_type <- cn_block$get_type
alter_fun <- cn_block$alter_fun
col_map <- cn_block$col_map

missing_samples <- setdiff(all_samples, colnames(mat_top))
if (length(missing_samples) > 0) {
  mat_add <- matrix("", nrow = nrow(mat_top), ncol = length(missing_samples),
                    dimnames = list(rownames(mat_top), missing_samples))
  mat_top <- cbind(mat_top, mat_add)
}
mat_top <- mat_top[, all_samples]

anno_df <- clinical_sample_info %>%
  filter(Tumor_Sample_Barcode %in% colnames(mat_top)) %>%
  arrange(T1221, Sample_group)
mat_top <- mat_top[, anno_df$Tumor_Sample_Barcode]

bottom_anno <- HeatmapAnnotation(
  T1221 = anno_df$T1221,
  Sample_Group = anno_df$Sample_group,
  col = list(
    T1221 = t1221_colors,
    Sample_Group = sample_group_colors
    ),
  annotation_name_side = "left",
  annotation_legend_param = list(
    T1221 = list(title = "T1221"),
    Sample_Group = list(title = "Sample Group")
    )
)

ht_I <- ComplexHeatmap::oncoPrint(
  mat_top,
  get_type = get_type,
  alter_fun = alter_fun,
  col = col_map,
  top_annotation = HeatmapAnnotation(
    `Alteration burden` = anno_oncoprint_barplot(),
    annotation_name_side = "left"
  ),
  left_annotation = rowAnnotation(
    `Alteration freq` = anno_oncoprint_barplot(),
    annotation_name_rot = 0
  ),
  bottom_annotation = bottom_anno,
  column_order = anno_df$Tumor_Sample_Barcode,
  remove_empty_rows = TRUE,
  remove_empty_columns = FALSE,
  show_column_names = TRUE,
  column_labels = anno_df$Tumor_Sample_Barcode,
  column_names_gp = grid::gpar(fontsize = 8, rot = 45),
  column_title = base::paste("Top", params$num_top_regions, "CNV Regions (cytobands Ã— sample)")
)

print(ht_I)
```

#### CN Oncoplot, all samples, tier I and II

```{r oncoplot_dragen_cnbands_filter2, fig.width = 12}
cn_block <- preproc_oncocn(
  dt = dt_I_II, 
  cyto_file = params$cytoband_file, 
  gain = params$thr4gain, 
  loss = params$thr4loss, 
  top_regions = params$num_top_regions
)

mat_top <- cn_block$mat_top
get_type <- cn_block$get_type
alter_fun <- cn_block$alter_fun
col_map <- cn_block$col_map

missing_samples <- setdiff(all_samples, colnames(mat_top))
if (length(missing_samples) > 0) {
  mat_add <- matrix("", nrow = nrow(mat_top), ncol = length(missing_samples),
                    dimnames = list(rownames(mat_top), missing_samples))
  mat_top <- cbind(mat_top, mat_add)
}
mat_top <- mat_top[, all_samples]

anno_df <- clinical_sample_info %>%
  filter(Tumor_Sample_Barcode %in% colnames(mat_top)) %>%
  arrange(T1221, Sample_group)
mat_top <- mat_top[, anno_df$Tumor_Sample_Barcode]

bottom_anno <- HeatmapAnnotation(
  T1221 = anno_df$T1221,
  Sample_Group = anno_df$Sample_group,
  col = list(
    T1221 = t1221_colors,
    Sample_Group = sample_group_colors
    ),
  annotation_name_side = "left",
  annotation_legend_param = list(
    T1221 = list(title = "T1221"),
    Sample_Group = list(title = "Sample Group")
    )
)

ht_I_II <- ComplexHeatmap::oncoPrint(
  mat_top,
  get_type = get_type,
  alter_fun = alter_fun,
  col = col_map,
  top_annotation = HeatmapAnnotation(
    `Alteration burden` = anno_oncoprint_barplot(),
    annotation_name_side = "left"
  ),
  left_annotation = rowAnnotation(
    `Alteration freq` = anno_oncoprint_barplot(),
    annotation_name_rot = 0
  ),
  bottom_annotation = bottom_anno,
  column_order = anno_df$Tumor_Sample_Barcode,
  remove_empty_rows = TRUE,
  remove_empty_columns = TRUE,
  show_column_names = TRUE,
  column_labels = anno_df$Tumor_Sample_Barcode,
  column_names_gp = grid::gpar(fontsize = 8, rot = 45),
  column_title = base::paste("Top", params$num_top_regions, "CNV Regions (cytobands Ã— sample)")
)

print(ht_I_II)
```

#### CN Oncoplot, all samples, tier I, II and III

```{r oncoplot_dragen_cnbands_filter3, fig.width = 12}
cn_block <- preproc_oncocn(
  dt = dt_I_II_III, 
  cyto_file = params$cytoband_file, 
  gain = params$thr4gain, 
  loss = params$thr4loss, 
  top_regions = params$num_top_regions
)

mat_top <- cn_block$mat_top
get_type <- cn_block$get_type
alter_fun <- cn_block$alter_fun
col_map <- cn_block$col_map

missing_samples <- setdiff(all_samples, colnames(mat_top))
if (length(missing_samples) > 0) {
  mat_add <- matrix("", nrow = nrow(mat_top), ncol = length(missing_samples),
                    dimnames = list(rownames(mat_top), missing_samples))
  mat_top <- cbind(mat_top, mat_add)
}
mat_top <- mat_top[, all_samples]

anno_df <- clinical_sample_info %>%
  filter(Tumor_Sample_Barcode %in% colnames(mat_top)) %>%
  arrange(T1221, Sample_group)
mat_top <- mat_top[, anno_df$Tumor_Sample_Barcode]

bottom_anno <- HeatmapAnnotation(
  T1221 = anno_df$T1221,
  Sample_Group = anno_df$Sample_group,
  col = list(
    T1221 = t1221_colors,
    Sample_Group = sample_group_colors
    ),
  annotation_name_side = "left",
  annotation_legend_param = list(
    T1221 = list(title = "T1221"),
    Sample_Group = list(title = "Sample Group")
    )
)

ht_I_II_III <- ComplexHeatmap::oncoPrint(
  mat_top,
  get_type = get_type,
  alter_fun = alter_fun,
  col = col_map,
  top_annotation = HeatmapAnnotation(
    `Alteration burden` = anno_oncoprint_barplot(),
    annotation_name_side = "left"
  ),
  left_annotation = rowAnnotation(
    `Alteration freq` = anno_oncoprint_barplot(),
    annotation_name_rot = 0
  ),
  bottom_annotation = bottom_anno,
  column_order = anno_df$Tumor_Sample_Barcode,
  remove_empty_rows = TRUE,
  remove_empty_columns = TRUE,
  show_column_names = TRUE,
  column_labels = anno_df$Tumor_Sample_Barcode,
  column_names_gp = grid::gpar(fontsize = 8, rot = 45),
  column_title = base::paste("Top", params$num_top_regions, "CNV Regions (cytobands Ã— sample)")
)

print(ht_I_II_III)
```

## CN Table

The following table contains copy number data on all analyzed exome genes:

  - gene: the gene symbol
  
  - band: the band containing that gene
  
  - del_amp: either deletion or amplification
  
  - num_cases: number of cases with that copy number alteration
  
  - num_samples: number of total samples analyzed
  
  - freq_percent: the alteration frequence in percentage (cases / total samples)
  
  

```{r cn_table, results='hide', echo=FALSE}
allgenes_list <- getGeneSummary(maf_obj)$Hugo_Symbol

gene_entrez <- AnnotationDbi::select(org.Hs.eg.db,
                                    keys = allgenes_list,
                                    keytype = "SYMBOL",
                                    columns = c("ENTREZID"))

gene_entrez <- gene_entrez %>% filter(!is.na(ENTREZID))
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
gene_ranges <- genes(txdb, columns = c("gene_id"))
gene_ranges_filtered <- gene_ranges[as.character(names(gene_ranges)) %in% gene_entrez$ENTREZID]
gene_df <- as.data.frame(gene_ranges_filtered) %>%
  dplyr::select(seqnames, start, end, width, strand, gene_id)

gene_annotated <- gene_entrez %>%
  inner_join(gene_df, by = c("ENTREZID" = "gene_id")) %>%
  dplyr::rename(
    Chromosome = seqnames,
    Start_Position = start,
    End_Position = end
  )
gene_annotated <- gene_annotated %>%
  mutate(Chromosome = gsub("^chr", "", Chromosome)) %>%
  filter(!Chromosome %in% c("X", "Y"))

gene_gr <- GRanges(
  seqnames = gene_annotated$Chromosome,
  ranges = IRanges(
    start = gene_annotated$Start_Position,
    end   = gene_annotated$End_Position
  ),
  strand = "*"
)

mcols(gene_gr)$gene   <- gene_annotated$SYMBOL
mcols(gene_gr)$entrez <- gene_annotated$ENTREZID

cyto <- fread(
  params$cytoband_file,
  header = FALSE,
  fill = TRUE
)

colnames(cyto) <- c(
  "chrom",
  "chromStart",
  "chromEnd",
  "cytoband",
  "stain"
)

cyto <- cyto %>%
  mutate(band = paste0(gsub("^chr", "", chrom), cytoband))

cyto_gr <- GRanges(
  seqnames = gsub("^chr", "", cyto$chrom),
  ranges   = IRanges(cyto$chromStart, cyto$chromEnd)
)

mcols(cyto_gr)$band <- cyto$band

ov_cyto <- findOverlaps(gene_gr, cyto_gr)

gene_cytoband <- tapply(
  mcols(cyto_gr)$band[subjectHits(ov_cyto)],
  queryHits(ov_cyto),
  function(x) paste(unique(x), collapse = ",")
)

mcols(gene_gr)$band <- gene_cytoband[seq_along(gene_gr)]

cnv_files  <- mapping_table$cnv_file
sample_ids <- mapping_table$new_id
```

```{r table_loop, results='hide', echo=FALSE}
cnv_long <- list()
idx <- 1
total_samples <- (seq_along(cnv_files))

for (i in total_samples) {

  cnv <- fread(cnv_files[i])
  
  if (nrow(cnv) == 0) next

  cnv <- cnv %>%
    dplyr::mutate(
      Chromosome = gsub("^chr", "", Chromosome),
      cnv_type = case_when(
        Type == "DEL" ~ "DEL",
        Type == "DUP" ~ "AMP",
        TRUE ~ NA_character_
      )
    ) %>%
    filter(!is.na(cnv_type))

  cnv_gr <- GRanges(
    seqnames = cnv$Chromosome,
    ranges   = IRanges(cnv$Start, cnv$End)
  )

  mcols(cnv_gr)$cnv_type <- cnv$cnv_type

  hits <- findOverlaps(gene_gr, cnv_gr)

  if (length(hits) == 0) next

  cnv_long[[idx]] <- data.frame(
    gene   = mcols(gene_gr)$gene[queryHits(hits)],
    sample = sample_ids[i],
    cnv    = mcols(cnv_gr)$cnv_type[subjectHits(hits)],
    stringsAsFactors = FALSE
  )

  idx <- idx + 1
}

total_samples <- idx - 1
cnv_long <- bind_rows(cnv_long)
```

```{r final_annotation, results='hide', echo=FALSE}
cnv_long <- cnv_long %>%
  group_by(gene, sample) %>%
  summarise(
    cnv = case_when(
      "DEL" %in% cnv & "AMP" %in% cnv ~ "BOTH",
      "DEL" %in% cnv ~ "DEL",
      "AMP" %in% cnv ~ "AMP"
    ),
    .groups = "drop"
  )

gene_summary <- cnv_long %>%
  filter(cnv %in% c("DEL", "AMP")) %>%
  group_by(gene, cnv) %>%
  summarise(
    num_cases = n_distinct(sample),
    .groups = "drop"
  ) %>%
  group_by(gene)

gene_cyto_df <- data.frame(
  gene = mcols(gene_gr)$gene,
  band = mcols(gene_gr)$band,
  stringsAsFactors = FALSE
)

final_table <- gene_summary %>%
  mutate(
    num_samples = total_samples,
    freq_percent = 100 * num_cases / total_samples
  ) %>%
  left_join(gene_cyto_df, by = "gene") %>%
  dplyr::select(
    gene,
    band,
    del_amp = cnv,
    num_cases,
    num_samples,
    freq_percent
  ) %>%
  arrange(desc(freq_percent))
```

```{r plot_table, echo=FALSE}
DT::datatable(
  final_table,
  extensions = 'Buttons',
  options = list(
    dom = 'Blfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
    lengthMenu = list(c(10, 25, 50,-1),
                      c(10, 25, 50, "All"))
  ),
  rownames = TRUE,
)
```
