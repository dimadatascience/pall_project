---
title: "PALL visualization data"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    theme: united
    code_folding: hide
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: "Gianluca Alessio Mariani"

params:
  manual_timestamp: "250929_0900"
  project: "pall"
  clinical_data: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/clinical_data.csv"
  maf_tumor_dir: "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4/annotations/variant_annotations/250916/annotation/somatic"
  cnv_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/variantalker/results/250923_1647_pall/250923/annotation/cnv"
  raw_samples_dir: "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4"
  results_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results"
  refgene_file: "/hpcnfs/scratch/DIMA/gmariani/__softwares/gistic2/gistic2/refgenes/hg38.UCSC.add_mir.160920/gistic2.refgene.hg38.UCSC.add_miR.160920.mat"
  cytoband_file: "/hpcnfs/scratch/DIMA/gmariani/_databases/reference_genomes/hg38/cytoBand_hg38.txt"
  gene_table1: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_PrimaryTumors/FINAL_DATASET.csv"
  gene_table2: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_RelapseTumors/FINAL_DATASET.csv"
  cnvkit_out_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results/250918_1626_cnvkit_pall"
  run_gistic2: FALSE
  num_top_genes: 20
  num_top_regions: 20
  type2use4cn_onco: "anno" #either "anno" or "seg"
  thr4gain: 0.30
  thr4amp: 0.90 
  thr4loss: -0.30 
  thr4deep: -0.90 
---

```{r setup_knit, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.align = "center",
	fig.height = 8,
	fig.width = 10,
	message = FALSE,
	warning = FALSE,
	autodep = TRUE,
	cache = FALSE
)
```

```{r params_for_interactive_session}
# Chunk: setup_parameters
if (!exists("params")) {
  params <- list(
    manual_timestamp = "250929_0900",
    project = "pall",
    clinical_data = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/clinical_data.csv",
    maf_tumor_dir = "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4/annotations/variant_annotations/250916/annotation/somatic",
    cnv_dir = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/variantalker/results/250923_1647_pall/250923/annotation/cnv",
    raw_samples_dir = "/hpcnfs/scratch/P_DIMA_PALL/wes/250912_rerun_dragen4.4.4",
    results_dir = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results",
    refgene_file = "/hpcnfs/scratch/DIMA/gmariani/__softwares/gistic2/gistic2/refgenes/hg38.UCSC.add_mir.160920/gistic2.refgene.hg38.UCSC.add_miR.160920.mat",
    gene_table1 = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_PrimaryTumors/FINAL_DATASET.csv",
    gene_table2 = "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/data/PALL_WES_RelapseTumors/FINAL_DATASET.csv",
    cnvkit_out_dir: "/hpcnfs/scratch/DIMA/gmariani/PROJECTS/pall_ALL/results/250918_1626_cnvkit_pall",
    run_gistic2 = FALSE
  )
}

if (!is.null(params$manual_timestamp) && 
    !is.na(params$manual_timestamp) &&
    params$manual_timestamp != "") {
  manual_timestamp <- params$manual_timestamp
} else {
  manual_timestamp <- format(Sys.time(), "%y%m%d_%H%M")
}
```

```{r load_libraries_and_setup, results='hide'}
library(grDevices)
library(maftools)
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)
library(GenomicRanges)
library(readr)
library("mclust")
library(ggplot2)
library(circlize)
library(RCircos)
library("RColorBrewer")
library(grDevices)
library(ComplexHeatmap)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library('org.Hs.eg.db')
library(AnnotationDbi)
library(biovizBase)
library(grid)
library(purrr)
```

```{r functions1}
get_sample_id <- function(filepath) {
  tools::file_path_sans_ext(basename(filepath)) %>% 
    sub("\\.cnv\\.annotated$", "", .) %>% 
    sub("\\.target\\.counts$", "", .)
}

process_cnv_sample <- function(cnv_file) {
  sample_id <- strsplit(basename(cnv_file), "\\.")[[1]][[1]]
  
  # 1. Leggi CNV
  cnv <- tryCatch({
    read.delim(cnv_file, header = TRUE, sep = "\t", stringsAsFactors = FALSE)
  }, error = function(e) {
    message(sprintf("Errore nella lettura di %s: %s", cnv_file, e$message))
    return(NULL)
  })
  
  if (is.null(cnv) || !"All.protein.coding.genes" %in% colnames(cnv)) return(NULL)
  cnv <- cnv[cnv$All.protein.coding.genes != "", ]
  cnv$CNV_Status <- ifelse(cnv$Type == "DEL", "Del",
                           ifelse(cnv$Type == "DUP", "Amp", NA))
  cnv <- cnv[!is.na(cnv$CNV_Status), ]
  if (nrow(cnv) == 0) return(NULL)

  cnv_gr <- GRanges(
    seqnames = cnv$Chromosome,
    ranges = IRanges(start = cnv$Start, end = cnv$End)
  )

  # ðŸ”¹ File gene-level (solo se ti serve)
  gene_annotation_df <- cnv %>%
    mutate(Sample = sample_id,
           Start_Position = Start,
           End_Position = End) %>%
    separate_rows(All.protein.coding.genes, sep = ",\\s*") %>%
    mutate(Hugo_Symbol = All.protein.coding.genes) %>%
    dplyr::select(Hugo_Symbol, Sample, CNV_Status, Chromosome, Start_Position, End_Position)

  # Ritorna entrambi
  return(list(
    cnv_list = gene_annotation_df
  ))
}
```

```{r functions2}
apply_priority <- function(df, colnames_list, priority, new_colname = "Clinical_Significance_Summary") {
  
  colnames_vec <- unlist(colnames_list)
  df <- as.data.frame(df)
  
  # Funzione che prende un vettore di tag e sceglie quello con prioritÃ  piÃ¹ alta
  select_highest_priority <- function(tags) {
    tags <- trimws(tags)
    tags <- tags[tags != "" & !is.na(tags)]
    
    for (p in priority) {
      if (p %in% tags) return(p)
    }
    return(NA_character_)
  }
  
  df[[new_colname]] <- apply(df[, colnames_vec, drop=FALSE], 1, select_highest_priority)
  
  return(data.table(df))
}


simplify_clinvar <- function(value, priority, mapping) {
  if (is.na(value) || trimws(value) == "") {
    return("Not_Provided")
  }
  
  # Split per tutti i separatori
  tags <- unlist(strsplit(value, "[|/;,]"))
  tags <- trimws(tags)
  
  # Applica il mapping ai tag
  mapped_tags <- sapply(tags, function(x) {
    if (x %in% names(mapping)) {
      return(mapping[[x]])
    } else {
      return(x)
    }
  }, USE.NAMES = FALSE)
  
  # Trova il primo tag con prioritÃ  piÃ¹ alta nel mapping
  for (p in priority) {
    if (p %in% mapped_tags) {
      return(p)
    }
  }
  
  # Se nessun match nella prioritÃ , restituisce il primo tag mappato
  return(mapped_tags[1])
}
```

```{r functions3}
preproc_oncocn <- function(dt, cyto_file, gain = 0.30, amp = 0.90, loss = -0.30, deep = -0.90, top_regions) {
# ---- 2) Normalizza nomi cromosomi ----
dt <- dt %>%
  mutate(Chromosome = ifelse(grepl("^chr", Chromosome), Chromosome, paste0("chr", Chromosome)))

# ---- 3) Crea GRanges per segmenti ----
cnv_gr <- GRanges(
  seqnames = dt$Chromosome,
  ranges = IRanges(start = dt$Start, end = dt$End),
  sample = dt$Sample,
  log2R = log2(dt$Segment_Mean)
)

# ---- 4) Carica bande citogenetiche ----
cyto <- read.delim(cyto_file, header = FALSE, stringsAsFactors = FALSE)
colnames(cyto) <- c("chrom", "chromStart", "chromEnd", "name", "gieStain")

cyto_gr <- GRanges(
  seqnames = cyto$chrom,
  ranges = IRanges(start = cyto$chromStart + 1, end = cyto$chromEnd),
  name = cyto$name,
  gieStain = cyto$gieStain
)

cyto_gr$region <- paste0(seqnames(cyto_gr), cyto_gr$name)

# ---- 5) Match seqlevels ----
seqlevelsStyle(cnv_gr) <- "UCSC"
cyto_gr <- keepSeqlevels(cyto_gr, intersect(seqlevels(cyto_gr), seqlevels(cnv_gr)), pruning.mode = "coarse")
cnv_gr  <- keepSeqlevels(cnv_gr, intersect(seqlevels(cyto_gr), seqlevels(cnv_gr)), pruning.mode = "coarse")

# ---- 6) Trova overlap tra CNV e bande ----
ov <- findOverlaps(cnv_gr, cyto_gr, ignore.strand = TRUE)
qh <- queryHits(ov)
sh <- subjectHits(ov)

# ---- 7) Calcola log2R medio pesato per (sample, regione) ----
ints <- pintersect(cnv_gr[qh], cyto_gr[sh])
df_raw <- data.frame(
  sample = cnv_gr$sample[qh],
  region = cyto_gr$region[sh],
  log2R = cnv_gr$log2R[qh],
  w = width(ints),
  stringsAsFactors = FALSE
)

df <- df_raw %>%
  group_by(sample, region) %>%
  summarise(
    log2R = weighted.mean(log2R, w),
    total_w = sum(w),
    .groups = "drop"
  )

# ---- 8) Classifica in base al log2R aggregato ----
thr <- list(gain = gain, amp = amp, loss = loss, deep = deep)

df <- df %>%
  mutate(call = case_when(
    log2R >= thr$amp  ~ "AMP",
    log2R >= thr$gain ~ "GAIN",
    log2R <= thr$deep ~ "HOMDEL",
    log2R <= thr$loss ~ "DEL",
    TRUE              ~ ""
  )) %>%
  filter(call != "")

# ---- 9) Costruisci matrice regione Ã— sample ----
mat <- df %>%
  dplyr::select(sample, region, call) %>%
  pivot_wider(names_from = sample, values_from = call, values_fill = "") %>%
  group_by(region) %>%
  summarise(across(everything(), ~ paste(unique(.), collapse = ";")), .groups = "drop") %>%
  tibble::column_to_rownames("region") %>%
  as.matrix()

top_n <- top_regions
region_freq <- apply(mat, 1, function(x) sum(x != ""))
top_regions <- names(sort(region_freq, decreasing = TRUE))[1:top_n]
mat_top <- mat[top_regions, , drop = FALSE]

# ---- 10) Definisci colori e funzioni per oncoPrint ----
col_map <- c(AMP = "#e41a1c", GAIN = "#fb9a99", DEL = "#377eb8", HOMDEL = "#08519c")

alter_fun <- list(
  background = function(x, y, w, h) {
    grid::grid.rect(x, y, w, h, gp = grid::gpar(fill = "#f2f2f2", col = NA))
  },
  AMP = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["AMP"], col = NA))
  },
  GAIN = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["GAIN"], col = NA))
  },
  DEL = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["DEL"], col = NA))
  },
  HOMDEL = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["HOMDEL"], col = NA))
  }
)

get_type <- function(x) strsplit(x, ";")[[1]]

return(list(mat_top = mat_top, col_map = col_map, alter_fun = alter_fun, get_type = get_type))
}
```

```{r preprocessing, results='hide'}
samples <- list.dirs(params$maf_tumor_dir, full.names = FALSE, recursive = FALSE)

final_genetable <- bind_rows(
  read_csv(params$gene_table1),
  read_csv(params$gene_table2)
)

genelist <- unique(final_genetable$Hugo_Symbol)

cnv_files <- file.path(params$cnv_dir, samples, paste0(samples, ".cnv.annotated.tsv"))
cnv_files <- cnv_files[file.exists(cnv_files)]

cnv_samples <- setNames(cnv_files, sapply(cnv_files, get_sample_id))

results <- lapply(cnv_files, process_cnv_sample)
```

```{r generate_files, results='hide'}
# Combina tutti i risultati validi
cnv_combined <- bind_rows(lapply(results, `[[`, "cnv_list"))

maf_files <- file.path(params$maf_tumor_dir, samples, paste0(samples, ".maf"))
maf_files <- maf_files[file.exists(maf_files)]
merged_maf <- merge_mafs(maf_files)

maf_obj <- read.maf(maf = merged_maf@data, clinicalData = params$clinical_data, cnTable = cnv_combined)
```

```{r clin_summary_setup}
clinvar_dict <- c("Pathogenic" = "Pathogenic",
    "Pathogenic/Likely_pathogenic" = "Pathogenic",
    "Likely_pathogenic" = "Likely_Pathogenic",
    "Uncertain_significance" = "Uncertain_Significance",
    "Conflicting_classifications_of_pathogenicity" = "Uncertain_Significance",
    "Conflicting_interpretations_of_pathogenicity" = "Uncertain_Significance",
    "Likely_benign" = "Likely_Benign",
    "Benign/Likely_benign" = "Likely_Benign",
    "Benign" = "Benign",
    "drug_response" = "Drug_Response",
    "not_provided" = "Not_Provided",
    "no_classifications_from_unflagged_records" = "Unknown",
    "risk_factor" = "Unknown",
    "Affects" = "Unknown",
    "no_classification_for_the_single_variant" = "Unknown",
    "association" = "Unknown",
    "other" = "Unknown",
    "Uncertain_risk_allele" = "Unknown",
    "Likely_risk_allele" = "Unknown",
    "_low_penetrance" = "Unknown",
    "protective" = "Unknown",
    "association_not_found" = "Unknown",
    "Established_risk_allele" = "Unknown",
    "confers_sensitivity" = "Unknown")

cancervar_dict <- list("Tier_I_strong" = "Pathogenic",
    "Tier_II_potential" = "Likely_Pathogenic",
    "Tier_III_Uncertain" = "Uncertain_Significance",
    "Tier_IV_benign" = "Benign")

varsome_dict  <- list("TierI" = "Pathogenic",
                      "TierIV" = "Benign",
                      "TierIII" = "Uncertain_Significance",
                      "??" = "Unknown",
                      "TierII" = "Likely_pathogenic",
                      "???" = "Unknown")

priority_order <- list("Pathogenic",
    "Likely_Pathogenic",
    "Uncertain_Significance",
    "Likely_Benign",
    "Benign",
    "Drug_Response",
    "Not_Provided",
    "Unknown")

cols_to_check_clin_canc <- list("CancerVar", "ClinVar_VCF_CLNSIG")
cols_to_check_chiara <- list("VARSOME", "CancerVar", "ClinVar_VCF_CLNSIG")
```

```{r clin_summary_exec}
maf_data <- maf_obj@data

maf_data <- maf_data %>%
  dplyr::left_join(
    final_genetable %>% dplyr::select(Chromosome, Start_Position, End_Position, VARSOME),
    by = c("Chromosome", "Start_Position", "End_Position")
  )

maf_data$ClinVar_VCF_CLNSIG <- sapply(
  maf_data$ClinVar_VCF_CLNSIG,
  simplify_clinvar,
  priority = priority_order,
  mapping = clinvar_dict,
  USE.NAMES = FALSE
)
maf_data$CancerVar[is.na(maf_data$CancerVar)] <- "Not_Provided"
maf_data$CancerVar <- recode(maf_data$CancerVar, !!!cancervar_dict)
maf_data$VARSOME[is.na(maf_data$VARSOME)] <- "Not_Provided"
maf_data$VARSOME <- recode(maf_data$VARSOME, !!!varsome_dict)

maf_obj@data <- maf_data

maf_obj@data <- apply_priority(maf_obj@data, cols_to_check_clin_canc, priority_order, new_colname = "Clinical_Significance_Summary_Clinvar_Cancervar")
maf_obj@data <- apply_priority(maf_obj@data, cols_to_check_chiara, priority_order, new_colname = "Clinical_Significance_Summary_Chiara")
```

```{r genelists, results='hide'}
maf_obj_filtered_I <- maf_obj
maf_obj_filtered_I_chiara <- maf_obj
maf_obj_filtered_I_II <- maf_obj
maf_obj_filtered_I_II_chiara <- maf_obj
maf_obj_filtered_I_II_III <- maf_obj
maf_obj_filtered_I_II_III_chiara <- maf_obj

maf_obj_filtered_I_II_III@data <- maf_obj@data[maf_obj@data$Clinical_Significance_Summary_Clinvar_Cancervar %in% c("Pathogenic", "Likely_Pathogenic", "Uncertain_Significance"), ]
genelist_filtered_I_II_III <- unique(maf_obj_filtered_I_II_III@data$Hugo_Symbol)

maf_obj_filtered_I_II@data <- maf_obj@data[maf_obj@data$Clinical_Significance_Summary_Clinvar_Cancervar %in% c("Pathogenic", "Likely_Pathogenic"), ]
genelist_filtered_I_II <- unique(maf_obj_filtered_I_II@data$Hugo_Symbol)

maf_obj_filtered_I@data <- maf_obj@data[maf_obj@data$Clinical_Significance_Summary_Clinvar_Cancervar %in% c("Pathogenic"), ]
genelist_filtered_I <- unique(maf_obj_filtered_I@data$Hugo_Symbol)

maf_obj_filtered_I_II_III_chiara@data <- maf_obj@data[maf_obj@data$Clinical_Significance_Summary_Chiara %in% c("Pathogenic", "Likely_Pathogenic", "Uncertain_Significance"), ]
genelist_filtered_I_II_III_chiara <- unique(maf_obj_filtered_I_II_III_chiara@data$Hugo_Symbol)

maf_obj_filtered_I_II_chiara@data <- maf_obj@data[maf_obj@data$Clinical_Significance_Summary_Chiara %in% c("Pathogenic", "Likely_Pathogenic"), ]
genelist_filtered_I_II_chiara <- unique(maf_obj_filtered_I_II_chiara@data$Hugo_Symbol)

maf_obj_filtered_I_chiara@data <- maf_obj@data[maf_obj@data$Clinical_Significance_Summary_Chiara %in% c("Pathogenic"), ]
genelist_filtered_I_chiara <- unique(maf_obj_filtered_I_chiara@data$Hugo_Symbol)
```

```{r filters_genes, results='hide'}
clin_data <- maf_obj@clinical.data
clin_data_sorted <- clin_data[order(clin_data$T1221, clin_data$Sample_group), ]
clin_data_sorted_samples_paired <- clin_data[order(clin_data$Tumor_Sample_Barcode, clin_data$T1221, clin_data$Sample_group), ]
sample_order <- clin_data_sorted$Tumor_Sample_Barcode
sample_order_paired <- clin_data_sorted_samples_paired$Tumor_Sample_Barcode

# gene filters
mut_summary <- getGeneSummary(maf_obj)
mut_summary_filtered <- mut_summary[mut_summary$Hugo_Symbol %in% genelist, ]
top_in_genelist <- head(mut_summary_filtered[order(-mut_summary_filtered$MutatedSamples), "Hugo_Symbol"], params$num_top_genes)

mut_summary_filtered_I_II <- mut_summary_filtered[mut_summary_filtered$Hugo_Symbol %in% genelist_filtered_I_II, ]
top_in_genelist_I_II <- head(mut_summary_filtered_I_II[order(-mut_summary_filtered_I_II$MutatedSamples), "Hugo_Symbol"], params$num_top_genes)

mut_summary_filtered_I_II_III <- mut_summary_filtered[mut_summary_filtered$Hugo_Symbol %in% genelist_filtered_I_II_III, ]
top_in_genelist_I_II_III <- head(mut_summary_filtered_I_II_III[order(-mut_summary_filtered_I_II_III$MutatedSamples), "Hugo_Symbol"], params$num_top_genes)

mut_summary_filtered_I_II_chiara <- mut_summary_filtered[mut_summary_filtered$Hugo_Symbol %in% genelist_filtered_I_II_chiara, ]
top_in_genelist_I_II_chiara <- head(mut_summary_filtered_I_II_chiara[order(-mut_summary_filtered_I_II_chiara$MutatedSamples), "Hugo_Symbol"], params$num_top_genes)

mut_summary_filtered_I_II_III_chiara <- mut_summary_filtered[mut_summary_filtered$Hugo_Symbol %in% genelist_filtered_I_II_III_chiara, ]
top_in_genelist_I_II_III_chiara <- head(mut_summary_filtered_I_II_III_chiara[order(-mut_summary_filtered_I_II_III_chiara$MutatedSamples), "Hugo_Symbol"], params$num_top_genes)
```

```{r filters_samples, results='hide'}
# sample filters
sample_order_diag_relapse <- clin_data_sorted$Tumor_Sample_Barcode[
  clin_data_sorted$Sample_group %in% c("diag", "relapse1")
]
maf_obj_filtered_diag_relapse <- subsetMaf(maf = maf_obj, tsb = sample_order_diag_relapse)

samples_neg_diag_relapse <- clin_data_sorted$Tumor_Sample_Barcode[
  clin_data_sorted$T1221 == "NEG" &
  clin_data_sorted$Sample_group %in% c("diag", "relapse1")
]

samples_pos_diag_relapse <- clin_data_sorted$Tumor_Sample_Barcode[
  clin_data_sorted$T1221 == "POS" &
  clin_data_sorted$Sample_group %in% c("diag", "relapse1")
]


sample_order_diag <- clin_data_sorted$Tumor_Sample_Barcode[
  clin_data_sorted$Sample_group %in% c("diag")
]
maf_obj_filtered_diag <- subsetMaf(maf = maf_obj, tsb = sample_order_diag)

sample_order_relapse <- clin_data_sorted$Tumor_Sample_Barcode[
  clin_data_sorted$Sample_group %in% c("relapse1")
]
maf_obj_filtered_relapse <- subsetMaf(maf = maf_obj, tsb = sample_order_relapse)

samples_neg <- clin_data_sorted$Tumor_Sample_Barcode[clin_data_sorted$T1221 == "NEG"]
maf_obj_filtered_neg <- subsetMaf(maf = maf_obj, tsb = samples_neg)
samples_pos <- clin_data_sorted$Tumor_Sample_Barcode[clin_data_sorted$T1221 == "POS"]
maf_obj_filtered_pos <- subsetMaf(maf = maf_obj, tsb = samples_pos)
```

```{r setup_directories}
# setup directories
output_dir <- file.path(params$results_dir, paste0(manual_timestamp, "_", params$project))
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
```

# Maftools Report

## Summary

### Summary - all samples

```{r summary1}
plotmafSummary(maf = maf_obj, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
```

### Summary - diagnosis samples

```{r summary2}
plotmafSummary(maf = maf_obj_filtered_diag, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
```

### Summary - first relapse samples

```{r summary3}
plotmafSummary(maf = maf_obj_filtered_relapse, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
```

### Oncoplots (VCC = VARSOME + CANCERVAR + CLINVAR, CC = CANCERVAR + CLINVAR)

#### Most pathogenic in VCC, Tier I and II genes

##### All samples

```{r oncoplot1, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = maf_obj_filtered_I_II_chiara,
  genes = top_in_genelist_I_II_chiara$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot1pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot1neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




#### Most pathogenic in VCC, Tier I, II and III genes

##### All samples

```{r oncoplot2, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = maf_obj_filtered_I_II_III_chiara,
  genes = top_in_genelist_I_II_III_chiara$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot2pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III_chiara, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot2neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III_chiara, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```



#### Most pathogenic in CC, Tier I and II genes

##### All samples

```{r oncoplot3, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = maf_obj_filtered_I_II,
  genes = top_in_genelist_I_II$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot3pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot3neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```





#### Most pathogenic in CC, Tier I, II and III genes, all samples

##### All samples

```{r oncoplot4, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = maf_obj_filtered_I_II_III,
  genes = top_in_genelist_I_II_III$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot4pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III, tsb = samples_pos),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot4neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III, tsb = samples_neg),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




#### Most pathogenic in VCC, Tier I and II genes, only diagnosis and relapse 1 samples

##### All samples

```{r oncoplot5, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = sample_order_diag_relapse),
  genes = top_in_genelist_I_II_chiara$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot5pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot5neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




#### Most pathogenic in VCC, Tier I, II and III genes, only diagnosis and relapse 1 samples

##### All samples

```{r oncoplot6, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III_chiara, tsb = sample_order_diag_relapse),
  genes = top_in_genelist_I_II_chiara$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot6pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III_chiara, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot6neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III_chiara, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




#### Most pathogenic in CC, Tier I, and II genes, only diagnosis and relapse 1 samples

##### All samples

```{r oncoplot7, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II, tsb = sample_order_diag_relapse),
  genes = top_in_genelist_I_II_chiara$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot7pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot7neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```




#### Most pathogenic in CC, Tier I, II and III genes, only diagnosis and relapse 1 samples

##### All samples

```{r oncoplot8, results='hide', echo=FALSE}
main_onco <- oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III, tsb = sample_order_diag_relapse),
  genes = top_in_genelist_I_II_chiara$Hugo_Symbol, 
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = sample_order
  )
gene_order <- rownames(main_onco$oncomatrix)
print(main_onco)
```

##### Positive samples

```{r oncoplot8pos, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III, tsb = samples_pos_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_pos
  )
```

##### Negative samples

```{r oncoplot8neg, results='hide', echo=FALSE}
oncoplot(
  maf = subsetMaf(maf = maf_obj_filtered_I_II_III, tsb = samples_neg_diag_relapse),
  genes = gene_order, 
  keepGeneOrder = TRUE,
  GeneOrderSort = FALSE,
  showTumorSampleBarcodes = TRUE, 
  barcode_mar = 12.5, 
  clinicalFeatures = c("T1221", "Sample_group"), 
  SampleNamefontSize = 1.3,
  sampleOrder = samples_neg
  )
```



```{r all_patients_oncoplot, results='asis', dev='svg', fig.height=6}
all_barcodes <- unique(maf_obj@data$Tumor_Sample_Barcode)
patient_ids <- gsub("-.*", "", all_barcodes)
barcode_map <- split(all_barcodes, patient_ids)
```

```{r onco_allpat1, fig.width=8, fig.height=10, eval=FALSE}
for (patient in names(barcode_map)) {
  patient_barcodes <- barcode_map[[patient]]
  
  maf_patient_tierI <- subsetMaf(maf = maf_obj_filtered_I, tsb = patient_barcodes)
  top_genes_tierI <- getGeneSummary(maf_patient_tierI)

  if (nrow(top_genes_tierI) > 0) {
    genes_to_plot_tierI <- head(top_genes_tierI$Hugo_Symbol, params$num_top_genes)
    
    if (length(genes_to_plot_tierI) >= 2) {

      # Verifica clinicalFeatures
      available_features <- intersect(c("T1221", "Sample_group"), colnames(maf_patient_tierI@clinical.data))
      valid_features <- available_features[
        sapply(maf_patient_tierI@clinical.data[, ..available_features], function(x) {
          sum(!is.na(x)) >= 2
        })
      ]

      cat("## Patient:", patient, "- Top", params$num_top_genes, "mutated genes in Tier I, most pathogenic in CC\n\n")
      
      onco_tierI <- oncoplot(
        maf = maf_patient_tierI,
        genes = genes_to_plot_tierI,
        showTumorSampleBarcodes = TRUE,
        clinicalFeatures = if (length(valid_features) > 0) valid_features else NULL,
        barcode_mar = 4,
        SampleNamefontSize = 1.3
      )
      cat("\n\n")
    } else {
      cat("## Patient:", patient, "- Not enough genes (", length(genes_to_plot_tierI), ") to plot for Tier I CC\n")
    }
  }
}
```

```{r onco_allpat2, eval=FALSE}
for (patient in names(barcode_map)) {
  
  patient_barcodes <- barcode_map[[patient]]
  
  # Tier I and II CC
  maf_patient_tierI_II <- subsetMaf(maf = maf_obj_filtered_I_II, tsb = patient_barcodes)
  top_genes_tierI_II <- getGeneSummary(maf_patient_tierI_II)
  
if (nrow(top_genes_tierI_II) > 0) {
  genes_to_plot_tierI_II <- head(top_genes_tierI_II$Hugo_Symbol, params$num_top_genes)

  if (length(genes_to_plot_tierI_II) >= 2) {   # <-- Controllo importante
    onco_tierI_II <- oncoplot(
      maf = maf_patient_tierI_II,
      genes = genes_to_plot_tierI_II,
      showTumorSampleBarcodes = TRUE,
      clinicalFeatures = c("T1221", "Sample_group"), 
      barcode_mar = 1,
      SampleNamefontSize = 1.3
    )

    cat("## Patient:", patient, "- Top", params$num_top_genes, "mutated genes in Tier I and II, most pathogenic in CC\n\n")
    print(onco_tierI_II)
    cat("\n\n")
  } else {
    cat(paste("## Patient:", patient, "- Not enough genes (", length(genes_to_plot_tierI_II), ") to plot for Tier I and II CC\n"))
  }
}
}
```

```{r onco_allpat3, eval=FALSE}

for (patient in names(barcode_map)) {
  
  patient_barcodes <- barcode_map[[patient]]
  
  # Tier I VCC
  
  maf_patient_tierI_chiara <- subsetMaf(maf = maf_obj_filtered_I_chiara, tsb = patient_barcodes)
  top_genes_tierI_chiara <- getGeneSummary(maf_patient_tierI_chiara)
  
if (nrow(top_genes_tierI_chiara) > 0) {
  genes_to_plot_tierI_chiara <- head(top_genes_tierI_chiara$Hugo_Symbol, params$num_top_genes)

if (length(genes_to_plot_tierI_chiara) >= 2) {   # <-- Controllo importante
  onco_tierI_chiara <- oncoplot(
    maf = maf_patient_tierI_chiara,
    genes = genes_to_plot_tierI_chiara,
    showTumorSampleBarcodes = TRUE,
    clinicalFeatures = c("T1221", "Sample_group"), 
    barcode_mar = 12.5,
    SampleNamefontSize = 1.3
  )

  cat("## Patient:", patient, "- Top", params$num_top_genes, "mutated genes in Tier I, most pathogenic in VCC\n\n")
  print(onco_tierI_chiara)
  cat("\n\n")
  } else {
    cat(paste("## Patient:", patient, "- Not enough genes (", length(genes_to_plot_tierI_chiara), ") to plot for Tier I VCC\n"))    
  }
} 
}
```

```{r onco_allpat4, eval=FALSE}

for (patient in names(barcode_map)) {
  
  patient_barcodes <- barcode_map[[patient]]
  
  # Tier I and II VCC
  
  maf_patient_tierI_II_chiara <- subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = patient_barcodes)
  top_genes_tierI_II_chiara <- getGeneSummary(maf_patient_tierI_II_chiara)
  
if (nrow(top_genes_tierI_II_chiara) > 0) {
  genes_to_plot_tierI_II_chiara <- head(top_genes_tierI_II$Hugo_Symbol, params$num_top_genes)

  if (length(genes_to_plot_tierI_II_chiara) >= 2) {   # <-- Controllo importante
  onco_tierI_II_chiara <- oncoplot(
    maf = maf_patient_tierI_II_chiara,
    genes = genes_to_plot_tierI_II_chiara,
    showTumorSampleBarcodes = TRUE,
    clinicalFeatures = c("T1221", "Sample_group"), 
    barcode_mar = 12.5,
    SampleNamefontSize = 1.3
  )
  
  cat("## Patient:", patient, "- Top", params$num_top_genes, "mutated genes in Tier I and II, most pathogenic in VCC\n\n")
  print(onco_tierI_II_chiara)
  } else {
    cat(paste("## Patient:", patient, "- Not enough genes (", length(genes_to_plot_tierI_II_chiara), ") to plot for Tier I and II VCC\n")) 
  }
}
}
```

```{r onco_allpat5, eval=FALSE}

for (patient in names(barcode_map)) {
  
  patient_barcodes <- barcode_map[[patient]]
  
if (nrow(top_genes_tierI) == 0 & nrow(top_genes_tierI_II) == 0 & nrow(top_genes_tierI) == 0 & nrow(top_genes_tierI_II) == 0) {
    cat("## Patient:", patient, " - No mutation found for Tier I and II\n\n")
  }
}
```

### Transitions-Transversions

```{r transition_transversions, fig.height=13}
maf_obj.titv = titv(maf = maf_obj, plot = FALSE, useSyn = TRUE)
plotTiTv(res = maf_obj.titv, showBarcodes = TRUE)
```

### TMB Comparison Graph

```{r TMB_comparison}
maf_obj.mutload = tcgaCompare(maf = maf_obj, cohortName = 'PALL', logscale = TRUE, capture_size = 50)
```

### VAF Plot, positive samples, most pathogenic in CC, Tier I and II genes

```{r vaf_plot1}
plotVaf(maf = subsetMaf(maf = maf_obj_filtered_I_II, tsb = samples_pos), vafCol = 'tumor_f', genes = genelist_filtered_I_II)
```

### VAF Plot, negative samples, most pathogenic in CC, Tier I and II genes

```{r vaf_plot2}
plotVaf(maf = subsetMaf(maf = maf_obj_filtered_I_II, tsb = samples_neg), vafCol = 'tumor_f', genes = genelist_filtered_I_II)
```

### VAF Plot, positive samples, most pathogenic in VCC, Tier I and II genes

```{r vaf_plot3}
plotVaf(maf = subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = samples_pos), vafCol = 'tumor_f', genes = genelist_filtered_I_II_chiara)
```

### VAF Plot, negative samples, most pathogenic in VCC, Tier I and II genes

```{r vaf_plot4}
plotVaf(maf = subsetMaf(maf = maf_obj_filtered_I_II_chiara, tsb = samples_neg), vafCol = 'tumor_f', genes = genelist_filtered_I_II_chiara)
```

## Additional Plots

### Oncodrivers

```{r oncodriver}
maf_obj.sig = oncodrive(maf = maf_obj, AACol = 'Protein_Change', minMut = 15, pvalMethod = 'zscore')
plotOncodrive(res = maf_obj.sig, fdrCutOff = 0.01, useFraction = TRUE, labelSize = 1.0)
```

### Survival Analysis

```{r surv_anal}
mafSurvival(maf = maf_obj, genes = 'TP53', time = 'efstime1', Status = 'D2_relapse', isTCGA = FALSE)
```

### Tumor Heterogeneity

```{r het}
IH_PALL <- inferHeterogeneity(maf = maf_obj, tsb = 'PALL04NU7A-1TAD104', vafCol = 'tumor_f')
plotClusters(clusters = IH_PALL)
```

### CN CNVKit, Manhattan Plot, Bins

```{r manhattan_manual_bins, eval=FALSE}

for (c_path in list.dirs(params$cnvkit_out_dir, recursive = FALSE)) {

  file <- file.path(c_path, paste0(basename(c_path), "_tumor.cnr"))
  
  cnr <- read_tsv(file, show_col_types = FALSE)
  # Potresti dover adattare se il file Ã¨ delimitato da tab, spazio, etc
  
  # 2. Pulisci/formata
  cnr2 <- cnr %>%
    filter(!is.na(log2)) %>%           # rimuove eventuali record mancanti
    mutate(chromosome = as.character(chromosome)) %>% 
    # se ci sono "X", "Y", ecc. conviene gestire separatamente
    # ordina i cromosomi
    mutate(chromosome = factor(chromosome,
                               levels = c(1:22, "X", "Y", "MT"))) %>% 
    arrange(chromosome, start)
  
  # 3. Calcola posizioni cumulative per ogni cromosoma
  # prima serve la dimensione massima di ogni cromosoma
  chr_sizes <- cnr2 %>%
    group_by(chromosome) %>%
    summarize(chr_max = max(end)) %>%
    arrange(chromosome) %>%
    mutate(chr_cum_start = lag(cumsum(chr_max), default = 0))
  
  # unisci con i dati principali
  cnr3 <- cnr2 %>%
    left_join(chr_sizes, by = "chromosome") %>%
    mutate(pos_cum = start + chr_cum_start)
  
  # 4. Plot
  p <- ggplot(cnr3, aes(x = pos_cum, y = log2, color = chromosome)) +
    geom_point(size = 0.5, alpha = 0.7) +
    scale_color_manual(values = rep(c("gray50", "gray80"), length.out = nlevels(cnr3$chromosome))) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +  # linea di riferimento
    theme_bw() +
    theme( 
      panel.border = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      axis.text.x = element_blank(),  # nasconde label dei cromosomi se troppo affollati
      axis.ticks.x = element_blank()  
    ) +
    labs(
      x = "Genomic position",
      y = "Log2 copy number ratio",
      title = "Manhattanâ€‘plot dei log2 ratio (bins WES)",
      color = "Cromosoma"
    )
  
  # 5. Aggiungi etichette dei cromosomi sullâ€™asse x
  # calcolare il centro di ciascun cromosoma per posizionare il nome
  centers <- chr_sizes %>%
    mutate(center = chr_cum_start + chr_max/2)
  
  print(
    p + scale_x_continuous(
          breaks = centers$center,
          labels = centers$chromosome,
          expand = c(0,0)
        )
  )
}
```

### CN CNVKit, Manhattan Plot, Segments

```{r manhattan_manual_seg_cnvkit}

for (c_path in list.dirs(params$cnvkit_out_dir, recursive = FALSE)) {

  file <- file.path(c_path, paste0(basename(c_path), "_tumor.cns"))
  
  cns <- read_tsv(file, show_col_types = FALSE)
  # Potresti dover adattare se il file Ã¨ delimitato da tab, spazio, etc
  
  cns2 <- cns %>%
    mutate(
      chromosome = gsub("^chr", "", chromosome),  # rimuove "chr" dal nome del cromosoma
      chromosome = factor(chromosome, levels = c(1:22, "X", "Y")),
      mid = (start + end) / 2
    ) %>%
    arrange(chromosome, start)
  
  # Calcola posizioni cumulative
  chr_sizes <- cns2 %>%
    group_by(chromosome) %>%
    summarize(chr_max = max(end)) %>%
    arrange(chromosome) %>%
    mutate(chr_cum_start = lag(cumsum(chr_max), default = 0))
  
  cns3 <- cns2 %>%
    left_join(chr_sizes, by = "chromosome") %>%
    mutate(pos_cum = mid + chr_cum_start,
           seg_width = end - start)
  
  # Calcola centro dei cromosomi per label
  centers <- chr_sizes %>%
    mutate(center = chr_cum_start + chr_max/2)
  
  n_chrom <- length(levels(cns3$chromosome))
    chrom_colors <- colorRampPalette(brewer.pal(12, "Paired"))(n_chrom)
  
  # 4. Plot
  p <- ggplot(cns3, aes(x = pos_cum, y = log2, group = chromosome)) +
    geom_segment(aes(x = start + chr_cum_start,
                     xend = end + chr_cum_start,
                     y = log2, yend = log2,
                     color = chromosome), size = 1) +
    scale_color_manual(values = chrom_colors) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    scale_x_continuous(breaks = centers$center, labels = centers$chromosome, expand = c(0,0)) +
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, size = 6),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    ) +
    labs(
      title = paste("Copy number segments (line plot) for sample", basename(c_path)),
      x = "Chromosome",
      y = "Log2 copy number ratio"
    )
  
  print(p)
}
```

### CN DRAGEN seg files, Manhattan Plot, Segments

```{r manhattan_manual_seg_dragen}

for (c_path in list.dirs(params$raw_samples_dir, recursive = FALSE)) {

  if (grepl("^PALL[0-9A-Za-z]+-[0-9]+T[0-9A-Za-z]+$", basename(c_path))) {
    file <- file.path(c_path, paste0(basename(c_path), ".seg"))
  
  cns <- read_tsv(file, show_col_types = FALSE)
  # Potresti dover adattare se il file Ã¨ delimitato da tab, spazio, etc
  
  cns2 <- cns %>%
    mutate(
      chromosome = gsub("^chr", "", Chromosome),  # rimuove "chr" dal nome del cromosoma
      chromosome = factor(chromosome, levels = c(1:22, "X", "Y")),
      mid = (Start + End) / 2,
      log2 = log2(Segment_Mean)
    ) %>%
    arrange(chromosome, Start)
  
  # Calcola posizioni cumulative
  chr_sizes <- cns2 %>%
    group_by(chromosome) %>%
    summarize(chr_max = max(End)) %>%
    arrange(chromosome) %>%
    mutate(chr_cum_start = lag(cumsum(chr_max), default = 0))
  
  cns3 <- cns2 %>%
    left_join(chr_sizes, by = "chromosome") %>%
    mutate(pos_cum = mid + chr_cum_start,
           seg_width = End - Start)
  
  cns3$log2_capped <- pmax(pmin(cns3$log2, 2.9), -2.9)
  
  # Calcola centro dei cromosomi per label
  centers <- chr_sizes %>%
    mutate(center = chr_cum_start + chr_max/2)
  
  n_chrom <- length(levels(cns3$chromosome))
    chrom_colors <- colorRampPalette(brewer.pal(12, "Paired"))(n_chrom)
  
  # 4. Plot
  p <- ggplot(cns3, aes(x = pos_cum, y = log2_capped, group = chromosome)) +
    geom_segment(aes(x = Start + chr_cum_start,
                     xend = End + chr_cum_start,
                     y = log2_capped, yend = log2_capped,
                     color = chromosome), size = 1) +
    scale_color_manual(values = chrom_colors) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    scale_x_continuous(breaks = centers$center, labels = centers$chromosome, expand = c(0,0)) +
    coord_cartesian(ylim = c(-3, 3)) + 
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, size = 6),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    ) +
    labs(
      title = paste("Copy number segments (line plot) for sample", basename(c_path)),
      x = "Chromosome",
      y = "Log2 copy number ratio"
    )
  
  print(p)
  }
}
```

### CN Oncoplot, DRAGEN annotation/seg files

```{r oncoplot_dragen_genes, eval=FALSE}
all_seg_data <- list()

for (c_path in list.dirs(params$raw_samples_dir, recursive = FALSE)) {

  # Filtro le directory che corrispondono al pattern
  if (grepl("^PALL[0-9A-Za-z]+-[0-9]+T[0-9A-Za-z]+$", basename(c_path))) {

    file <- file.path(c_path, paste0(basename(c_path), ".seg"))

    if (file.exists(file)) {
      # Leggi il file .seg con intestazione
      seg_data <- read_tsv(file, col_types = cols())  # usa read.table se Ã¨ .txt

      # Aggiungi alla lista
      all_seg_data[[length(all_seg_data) + 1]] <- seg_data
    }
  }
}

dt <- bind_rows(all_seg_data)
    
# ---- 0) your input ----
# Expecting columns: sample, chrom, start, end, log2R
# If you have a single sample and no 'sample' column, add one like: dt[, sample := "S1"]
 
# Normalize chromosome names to UCSC style (chr1..chr22, chrX, chrY)
if (!grepl("^chr", dt$Chromosome[1])) dt[, Chromosome := paste0("chr", Chromosome)]
 
# ---- 1) CNV segments as GRanges ----
cnv_gr <- GRanges(
  seqnames = dt$Chromosome,
  ranges   = IRanges(start = dt$Start, end = dt$End),
  log2R    = log2(dt$Segment_Mean),
  sample   = dt$Sample
)
 
# ---- 2) Gene coordinates (hg38) with symbols ----
txdb   <- TxDb.Hsapiens.UCSC.hg38.knownGene
gene_gr <- genes(txdb)                       # Entrez IDs
sym <- mapIds(org.Hs.eg.db,
              keys = as.character(gene_gr$gene_id),
              keytype = "ENTREZID", column = "SYMBOL")
gene_gr$symbol <- sym
gene_gr <- gene_gr[!is.na(gene_gr$symbol)]
seqlevelsStyle(gene_gr) <- "UCSC"
 
# keep standard chromosomes
keep <- intersect(seqlevels(gene_gr), seqlevels(cnv_gr))
gene_gr <- keepSeqlevels(gene_gr, keep, pruning.mode="coarse")
cnv_gr  <- keepSeqlevels(cnv_gr, keep, pruning.mode="coarse")
 
# ---- 3) Overlap & weighted mean log2R per gene/sample ----
ov <- findOverlaps(cnv_gr, gene_gr, ignore.strand = TRUE)
qh <- queryHits(ov); sh <- subjectHits(ov)
 
# intersection widths as weights
ints <- pintersect(cnv_gr[qh], gene_gr[sh])
w    <- width(ints)
 
df <- data.frame(
  sample = cnv_gr$sample[qh],
  gene   = gene_gr$symbol[sh],
  log2R  = cnv_gr$log2R[qh],
  w      = w,
  stringsAsFactors = FALSE
)
 
# weighted mean by sample Ã— gene
agg <- df %>%
  group_by(sample, gene) %>%
  summarise(log2R = sum(log2R * w) / sum(w), .groups = "drop")
 
# ---- 4) Discretize to events (tune thresholds to your platform) ----
thr <- list(gain = 0.30, amp = 0.90, loss = -0.30, deep = -0.90)
agg <- agg %>%
  mutate(call = case_when(
    log2R >= thr$amp        ~ "AMP",     # high-level amplification
    log2R >= thr$gain       ~ "GAIN",    # single-copy gain
    log2R <= thr$deep       ~ "HOMDEL",  # deep deletion
    log2R <= thr$loss       ~ "DEL",     # single-copy loss
    TRUE                    ~ ""         # neutral
  ))
 
# optional: focus on a gene panel or take the most frequently altered genes
top_n <- 30
top_genes <- agg %>%
  mutate(is_alt = call != "") %>%
  group_by(gene) %>%
  summarise(freq = mean(is_alt), .groups = "drop") %>%
  arrange(desc(freq)) %>% slice_head(n = top_n) %>% pull(gene)
 
agg_f <- agg %>% filter(gene %in% top_genes)
 
# wide matrix for oncoPrint (entries are "", "GAIN", "AMP", "DEL", "HOMDEL")
mat <- agg_f %>%
  dplyr::select(sample, gene, call) %>%
  mutate(call = replace_na(call, "")) %>%
  pivot_wider(names_from = sample, values_from = call, values_fill = "") %>%
  as.data.frame()
 
rownames(mat) <- mat$gene
mat$gene <- NULL
mat <- as.matrix(mat)
 
# ---- 5) Plot with ComplexHeatmap::oncoPrint ----
# colors and drawing functions for each alteration type
col_map <- c(AMP    = "#e41a1c",
             GAIN   = "#fb9a99",
             DEL    = "#377eb8",
             HOMDEL = "#08519c")
 
alter_fun <- list(
  background = function(x, y, w, h) {
    grid::grid.rect(x, y, w, h, gp = grid::gpar(fill = "#f2f2f2", col = NA))
  },
  AMP = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["AMP"], col = NA))
  },
  GAIN = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["GAIN"], col = NA))
  },
  DEL = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["DEL"], col = NA))
  },
  HOMDEL = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["HOMDEL"], col = NA))
  }
)
 
# Convert each cell to a vector of alteration types (here at most one per cell)
get_type <- function(x) strsplit(x, ";")[[1]]
 
ht <- oncoPrint(
  mat,
  get_type = get_type,
  alter_fun = alter_fun,
  col = col_map,
  remove_empty_rows = TRUE,
  remove_empty_columns = TRUE,
  column_title = "CNV Oncoprint (gene Ã— sample)",
  top_annotation = HeatmapAnnotation(
    `Alteration burden` = anno_oncoprint_barplot(),
    annotation_name_side = "left"
  ),
  left_annotation = rowAnnotation(
    `Alteration freq` = anno_oncoprint_barplot(),
    annotation_name_rot = 0
  )
)
 
ht
```

``` {r oncoplot_setup}
all_seg_data <- list()

if (params$type2use4cn_onco == "seg") {
  for (c_path in list.dirs(params$raw_samples_dir, recursive = FALSE)) {
    if (grepl("^PALL[0-9A-Za-z]+-[0-9]+T[0-9A-Za-z]+$", basename(c_path))) {
      file <- file.path(c_path, paste0(basename(c_path), ".seg"))
      if (file.exists(file)) {
        seg_data <- read_tsv(file, col_types = cols())
        seg_data$Sample <- basename(c_path)
        all_seg_data[[length(all_seg_data) + 1]] <- seg_data
      }
    }
  }
} else if (params$type2use4cn_onco == "anno") {
  for (c_path in list.dirs(params$cnv_dir, recursive = FALSE)) {
    if (grepl("^PALL[0-9A-Za-z]+-[0-9]+T[0-9A-Za-z]+$", basename(c_path))) {
      file <- file.path(c_path, paste0(basename(c_path), ".cnv.annotated.tsv"))
      if (file.exists(file)) {
        seg_data <- read_tsv(file, col_types = cols())
        seg_data$Sample <- basename(c_path)
        
        required_cols <- c("Sample", "Chromosome", "Start", "End", "Type", "Classification", "logRatio", "CNF")
        
        present_cols <- intersect(names(seg_data), required_cols)
        
        if (!"CNF" %in% present_cols) {
          stop(paste("File", file, "does not contain required column 'CNF'"))
        }
        
        seg_data <- seg_data %>%
          dplyr::select(all_of(present_cols)) %>%
          dplyr::rename(Segment_Mean = CNF)
        
        all_seg_data[[length(all_seg_data) + 1]] <- seg_data
      }
    }
  }
} else {
  stop(paste("ERROR: parameter 'type2use4cn_onco' must be 'seg' or 'anno'. Parameter used =", params$type2use4cn_onco))
}

dt <- bind_rows(all_seg_data)

dt_I <- dt[dt$Classification %in% c("Pathogenic"), ]
dt_I_II <- dt[dt$Classification %in% c("Pathogenic", "Likely pathogenic"), ]
dt_I_II_III <- dt[dt$Classification %in% c("Pathogenic", "Likely pathogenic", "Uncertain significance"), ]

clinical_sample_info <- data.frame(maf_obj@clinical.data)

t1221_colors <- c(NEG = "#1f78b4", POS = "#33a02c", NE = "#b2df8a")
sample_group_colors <- c(diag = "#e41a1c", relapse1 = "#377eb8", relapse2 = "#4daf4a")

```

```{r oncoplot_dragen_cnbands, eval=FALSE}
# ---- 2) Normalizza nomi cromosomi ----
dt <- dt %>%
  mutate(Chromosome = ifelse(grepl("^chr", Chromosome), Chromosome, paste0("chr", Chromosome)))

# ---- 3) Crea GRanges per segmenti ----
cnv_gr <- GRanges(
  seqnames = dt$Chromosome,
  ranges = IRanges(start = dt$Start, end = dt$End),
  sample = dt$Sample,
  log2R = log2(dt$Segment_Mean)
)

# ---- 4) Carica bande citogenetiche ----
cyto <- read.delim(params$cytoband_file, header = FALSE, stringsAsFactors = FALSE)
colnames(cyto) <- c("chrom", "chromStart", "chromEnd", "name", "gieStain")

cyto_gr <- GRanges(
  seqnames = cyto$chrom,
  ranges = IRanges(start = cyto$chromStart + 1, end = cyto$chromEnd),
  name = cyto$name,
  gieStain = cyto$gieStain
)

cyto_gr$region <- paste0(seqnames(cyto_gr), cyto_gr$name)

# ---- 5) Match seqlevels ----
seqlevelsStyle(cnv_gr) <- "UCSC"
cyto_gr <- keepSeqlevels(cyto_gr, intersect(seqlevels(cyto_gr), seqlevels(cnv_gr)), pruning.mode = "coarse")
cnv_gr  <- keepSeqlevels(cnv_gr, intersect(seqlevels(cyto_gr), seqlevels(cnv_gr)), pruning.mode = "coarse")

# ---- 6) Trova overlap tra CNV e bande ----
ov <- findOverlaps(cnv_gr, cyto_gr, ignore.strand = TRUE)
qh <- queryHits(ov)
sh <- subjectHits(ov)

# ---- 7) Calcola log2R medio pesato per (sample, regione) ----
ints <- pintersect(cnv_gr[qh], cyto_gr[sh])
df_raw <- data.frame(
  sample = cnv_gr$sample[qh],
  region = cyto_gr$region[sh],
  log2R = cnv_gr$log2R[qh],
  w = width(ints),
  stringsAsFactors = FALSE
)

df <- df_raw %>%
  group_by(sample, region) %>%
  summarise(
    log2R = weighted.mean(log2R, w),
    total_w = sum(w),
    .groups = "drop"
  )

# ---- 8) Classifica in base al log2R aggregato ----
thr <- list(gain = 0.30, amp = 0.90, loss = -0.30, deep = -0.90)

df <- df %>%
  mutate(call = case_when(
    log2R >= thr$amp  ~ "AMP",
    log2R >= thr$gain ~ "GAIN",
    log2R <= thr$deep ~ "HOMDEL",
    log2R <= thr$loss ~ "DEL",
    TRUE              ~ ""
  )) %>%
  filter(call != "")

# ---- 9) Costruisci matrice regione Ã— sample ----
mat <- df %>%
  dplyr::select(sample, region, call) %>%
  pivot_wider(names_from = sample, values_from = call, values_fill = "") %>%
  group_by(region) %>%
  summarise(across(everything(), ~ paste(unique(.), collapse = ";")), .groups = "drop") %>%
  tibble::column_to_rownames("region") %>%
  as.matrix()

top_n <- params$num_top_regions
region_freq <- apply(mat, 1, function(x) sum(x != ""))
top_regions <- names(sort(region_freq, decreasing = TRUE))[1:top_n]
mat_top <- mat[top_regions, , drop = FALSE]

# ---- 10) Definisci colori e funzioni per oncoPrint ----
col_map <- c(AMP = "#e41a1c", GAIN = "#fb9a99", DEL = "#377eb8", HOMDEL = "#08519c")

alter_fun <- list(
  background = function(x, y, w, h) {
    grid::grid.rect(x, y, w, h, gp = grid::gpar(fill = "#f2f2f2", col = NA))
  },
  AMP = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["AMP"], col = NA))
  },
  GAIN = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["GAIN"], col = NA))
  },
  DEL = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["DEL"], col = NA))
  },
  HOMDEL = function(x, y, w, h) {
    grid::grid.rect(x, y, w*0.9, h*0.9, gp = grid::gpar(fill = col_map["HOMDEL"], col = NA))
  }
)

get_type <- function(x) strsplit(x, ";")[[1]]
```

#### CN Oncoplot, all samples, tier I

```{r oncoplot_dragen_cnbands_filter1, fig.width = 12}
cn_block <- preproc_oncocn(
  dt = dt_I, 
  cyto_file = params$cytoband_file, 
  gain = params$thr4gain, 
  amp = params$thr4amp, 
  loss = params$thr4loss, 
  deep = params$thr4deep, 
  top_regions = params$num_top_regions
)

mat_top <- cn_block$mat_top
get_type <- cn_block$get_type
alter_fun <- cn_block$alter_fun
col_map <- cn_block$col_map

anno_df <- clinical_sample_info %>%
  filter(Tumor_Sample_Barcode %in% colnames(mat_top)) %>%
  arrange(T1221, Sample_group)
mat_top <- mat_top[, anno_df$Tumor_Sample_Barcode]

bottom_anno <- HeatmapAnnotation(
  T1221 = anno_df$T1221,
  Sample_Group = anno_df$Sample_group,
  col = list(
    T1221 = t1221_colors,
    Sample_Group = sample_group_colors
    ),
  annotation_name_side = "left",
  annotation_legend_param = list(
    T1221 = list(title = "T1221"),
    Sample_Group = list(title = "Sample Group")
    )
)

ht_I <- ComplexHeatmap::oncoPrint(
  mat_top,
  get_type = get_type,
  alter_fun = alter_fun,
  col = col_map,
  top_annotation = HeatmapAnnotation(
    `Alteration burden` = anno_oncoprint_barplot(),
    annotation_name_side = "left"
  ),
  left_annotation = rowAnnotation(
    `Alteration freq` = anno_oncoprint_barplot(),
    annotation_name_rot = 0
  ),
  bottom_annotation = bottom_anno,
  column_order = anno_df$Tumor_Sample_Barcode,
  remove_empty_rows = TRUE,
  remove_empty_columns = TRUE,
  show_column_names = TRUE,
  column_labels = anno_df$Tumor_Sample_Barcode,
  column_names_gp = grid::gpar(fontsize = 8, rot = 45),
  column_title = base::paste("Top", params$num_top_regions, "CNV Regions (cytobands Ã— sample)")
)

print(ht_I)
```

#### CN Oncoplot, all samples, tier I and II

```{r oncoplot_dragen_cnbands_filter2, fig.width = 12}
cn_block <- preproc_oncocn(
  dt = dt_I_II, 
  cyto_file = params$cytoband_file, 
  gain = params$thr4gain, 
  amp = params$thr4amp, 
  loss = params$thr4loss, 
  deep = params$thr4deep, 
  top_regions = params$num_top_regions
)

mat_top <- cn_block$mat_top
get_type <- cn_block$get_type
alter_fun <- cn_block$alter_fun
col_map <- cn_block$col_map

anno_df <- clinical_sample_info %>%
  filter(Tumor_Sample_Barcode %in% colnames(mat_top)) %>%
  arrange(T1221, Sample_group)
mat_top <- mat_top[, anno_df$Tumor_Sample_Barcode]

bottom_anno <- HeatmapAnnotation(
  T1221 = anno_df$T1221,
  Sample_Group = anno_df$Sample_group,
  col = list(
    T1221 = t1221_colors,
    Sample_Group = sample_group_colors
    ),
  annotation_name_side = "left",
  annotation_legend_param = list(
    T1221 = list(title = "T1221"),
    Sample_Group = list(title = "Sample Group")
    )
)

ht_I_II <- ComplexHeatmap::oncoPrint(
  mat_top,
  get_type = get_type,
  alter_fun = alter_fun,
  col = col_map,
  top_annotation = HeatmapAnnotation(
    `Alteration burden` = anno_oncoprint_barplot(),
    annotation_name_side = "left"
  ),
  left_annotation = rowAnnotation(
    `Alteration freq` = anno_oncoprint_barplot(),
    annotation_name_rot = 0
  ),
  bottom_annotation = bottom_anno,
  column_order = anno_df$Tumor_Sample_Barcode,
  remove_empty_rows = TRUE,
  remove_empty_columns = TRUE,
  show_column_names = TRUE,
  column_labels = anno_df$Tumor_Sample_Barcode,
  column_names_gp = grid::gpar(fontsize = 8, rot = 45),
  column_title = base::paste("Top", params$num_top_regions, "CNV Regions (cytobands Ã— sample)")
)

print(ht_I_II)
```

#### CN Oncoplot, all samples, tier I, II and III

```{r oncoplot_dragen_cnbands_filter3, fig.width = 12}
cn_block <- preproc_oncocn(
  dt = dt_I_II_III, 
  cyto_file = params$cytoband_file, 
  gain = params$thr4gain, 
  amp = params$thr4amp, 
  loss = params$thr4loss, 
  deep = params$thr4deep, 
  top_regions = params$num_top_regions
)

mat_top <- cn_block$mat_top
get_type <- cn_block$get_type
alter_fun <- cn_block$alter_fun
col_map <- cn_block$col_map

anno_df <- clinical_sample_info %>%
  filter(Tumor_Sample_Barcode %in% colnames(mat_top)) %>%
  arrange(T1221, Sample_group)
mat_top <- mat_top[, anno_df$Tumor_Sample_Barcode]

bottom_anno <- HeatmapAnnotation(
  T1221 = anno_df$T1221,
  Sample_Group = anno_df$Sample_group,
  col = list(
    T1221 = t1221_colors,
    Sample_Group = sample_group_colors
    ),
  annotation_name_side = "left",
  annotation_legend_param = list(
    T1221 = list(title = "T1221"),
    Sample_Group = list(title = "Sample Group")
    )
)

ht_I_II_III <- ComplexHeatmap::oncoPrint(
  mat_top,
  get_type = get_type,
  alter_fun = alter_fun,
  col = col_map,
  top_annotation = HeatmapAnnotation(
    `Alteration burden` = anno_oncoprint_barplot(),
    annotation_name_side = "left"
  ),
  left_annotation = rowAnnotation(
    `Alteration freq` = anno_oncoprint_barplot(),
    annotation_name_rot = 0
  ),
  bottom_annotation = bottom_anno,
  column_order = anno_df$Tumor_Sample_Barcode,
  remove_empty_rows = TRUE,
  remove_empty_columns = TRUE,
  show_column_names = TRUE,
  column_labels = anno_df$Tumor_Sample_Barcode,
  column_names_gp = grid::gpar(fontsize = 8, rot = 45),
  column_title = base::paste("Top", params$num_top_regions, "CNV Regions (cytobands Ã— sample)")
)

print(ht_I_II_III)
```
